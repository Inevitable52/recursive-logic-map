<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>P.E.R.C.Y - AI (Head Visual)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #0a0a0f;
    --neon-a: #00ffff;
    --neon-b: #ff00ff;
    --accent: #1aff55;
    --head-size: 520px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e8eefc;font-family:Consolas,monospace;overflow:hidden}
  /* map + nodes remain (but rings are replaced by head) */
  #logic-map{position:relative;width:100vw;height:100vh;background:#090912;overflow:hidden}
  #logic-nodes{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none}
  /* CENTER AI HEAD canvas */
  #ai-head-wrap{
    position:fixed;
    left:50%;
    top:40%;
    transform:translate(-50%,-50%);
    width:var(--head-size);
    height:var(--head-size);
    z-index:1200;
    pointer-events:none; /* let clicks fall through to UI */
    display:flex;
    align-items:center;
    justify-content:center;
  }
  canvas#ai-head{
    width:100%;
    height:100%;
    border-radius:18px;
    filter: drop-shadow(0 12px 40px rgba(0,0,0,0.7));
  }

  /* console / ui (kept) */
  #percy-console{position:fixed;left:6px;bottom:6px;width:34%;max-height:44%;overflow:auto;padding:12px;background:rgba(0,0,0,0.6);border-top-right-radius:12px;border:1px solid #222;z-index:1400}
  .console-line{font-size:12px;margin:4px 0;font-family:monospace}
  .console-line.ask{color:#cfe8ff}
  .console-line.exec{color:#9fffb0}
  #percy-message{position:fixed;left:34.5%;bottom:6px;width:65.5%;padding:12px;background:rgba(0,0,0,0.6);border-top-left-radius:12px;border:1px solid #222;z-index:1399;max-height:28%;overflow:auto}

  /* header inputs - keep Ask Percy + search */
  input,textarea,button{font-family:monospace}
  #seed-search{position:fixed;top:12px;left:12px;width:200px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1800}
  #interpreter-input{position:fixed;top:12px;left:220px;width:320px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1800}
  #askPercyButton{position:fixed;top:12px;left:550px;padding:6px 12px;border-radius:6px;background:#1a1aff;color:#fff;border:none;cursor:pointer;z-index:1800}
  #askPercyButton:hover{background:#3333ff}

  /* Exec area (kept but compact) */
  #percy-exec-input{position:fixed;top:52px;left:220px;width:360px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1700}
  #percy-exec-run{position:fixed;top:52px;left:588px;padding:6px 12px;border-radius:6px;border:0;background:var(--accent);color:#000;cursor:pointer;z-index:1700}

  /* camera */
  #camera-feed{position:fixed;top:110px;right:12px;width:420px;height:315px;border-radius:12px;border:2px solid var(--neon-a);box-shadow:0 0 18px var(--neon-a),0 0 36px var(--neon-b);background:#000;object-fit:cover;z-index:1500;transition:transform .25s}
  #camera-feed:hover{transform:scale(1.02)}
  #camera-overlay{position:fixed;top:110px;right:12px;width:420px;height:315px;pointer-events:none;z-index:1501}

  /* chat box (kept) */
  #percy-chat-box{
    position:fixed;
    bottom:20px;
    right:12px;
    width:340px;
    height:360px;
    background:rgba(0,0,0,0.75);
    border-radius:12px;
    border:1px solid #222;
    display:flex;
    flex-direction:column;
    z-index:1502;
    box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 0 18px var(--neon-b);
  }
  #percy-chat-messages{flex:1;padding:8px;overflow:auto}
  #percy-chat-input{flex:1;padding:6px;border:0;background:#111;color:#fff}
  #percy-chat-send{padding:6px 10px;border:0;background:var(--accent);color:#000;cursor:pointer;border-radius:6px}

  /* small responsive */
  @media (max-width:1100px){
    :root{--head-size:380px}
    #camera-feed{width:340px;height:255px;top:130px}
    #camera-overlay{width:340px;height:255px;top:130px}
    #percy-chat-box{right:8px;bottom:8px;width:300px;height:320px}
  }
  @media (max-width:700px){
    :root{--head-size:320px}
    #seed-search,#interpreter-input,#askPercyButton{display:block;left:8px;top:auto;position:fixed}
    #interpreter-input{top:56px;left:8px;width:58%}
    #askPercyButton{top:56px;left:68%}
    #ai-head-wrap{top:34%}
    #percy-console{width:96%;left:2%;bottom:6%}
    #percy-message{left:2%;width:96%;bottom:0;max-height:20%}
    #camera-feed{display:none}
    #camera-overlay{display:none}
  }
</style>
</head>
<body>

  <div id="logic-map"><div id="logic-nodes"></div></div>

  <!-- AI Head Canvas (center) -->
  <div id="ai-head-wrap" aria-hidden="true">
    <canvas id="ai-head" width="800" height="800"></canvas>
  </div>

  <!-- Console and message (UI sandbox) -->
  <div id="percy-console" aria-live="polite"></div>
  <div id="percy-message"></div>

  <!-- Controls (keep Ask Percy + Exec) -->
  <input id="seed-search" placeholder="Search seeds" />
  <input id="interpreter-input" placeholder="Ask Percy" />
  <button id="askPercyButton" title="Ask Percy">Run</button>

  <textarea id="percy-exec-input" rows="1" placeholder="Quick Exec (Math / Tools)"></textarea>
  <button id="percy-exec-run">Run Exec</button>

  <!-- Camera + overlay (kept) -->
  <video id="camera-feed" autoplay muted playsinline></video>
  <canvas id="camera-overlay"></canvas>

  <!-- Chat -->
  <div id="percy-chat-box" role="region" aria-label="Percy chat">
    <div id="percy-chat-messages"></div>
    <div style="display:flex;border-top:1px solid #222;padding:6px;">
      <input id="percy-chat-input" placeholder="Talk to Percy..." />
      <button id="percy-chat-send">Send</button>
    </div>
  </div>

  <!-- TF models (kept for detection) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
  
  <!-- === AI HEAD VISUAL (Structured Glow) === -->
<div id="percy-head-container">
  <div id="percy-head">
    <div class="head-layer base"></div>
    <div class="head-layer inner"></div>

    <div id="percy-eyes">
      <div class="eye left"></div>
      <div class="eye right"></div>
    </div>

    <div id="percy-mouth"></div>
  </div>
</div>

<style>
  /* ===== STRUCTURED AI HEAD ===== */
  #percy-head-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 320px;
    height: 360px;
    pointer-events: none;
    filter: drop-shadow(0 0 30px rgba(255,0,255,0.4))
            drop-shadow(0 0 60px rgba(0,255,255,0.2));
  }

  #percy-head {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50% / 56%;
    overflow: hidden;
  }

  /* Base contour (defines skull shape) */
  .head-layer.base {
    position: absolute;
    inset: 0;
    border-radius: 50% / 56%;
    background: radial-gradient(circle at 40% 40%, rgba(0,0,0,0.4), rgba(20,20,30,0.9));
    border: 2px solid rgba(255,255,255,0.08);
    box-shadow: inset 0 0 60px rgba(255,0,255,0.2), 0 0 20px rgba(0,255,255,0.15);
  }

  /* Inner light gradient for subtle dimensional depth */
  .head-layer.inner {
    position: absolute;
    inset: 0;
    border-radius: 50% / 56%;
    background: radial-gradient(circle at 45% 45%, rgba(255,0,255,0.15), rgba(0,255,255,0.05), transparent 80%);
    mix-blend-mode: screen;
  }

  /* Eyes */
  #percy-eyes {
    position: absolute;
    top: 28%;
    width: 100%;
    display: flex;
    justify-content: space-around;
  }

  .eye {
    width: 42px;
    height: 42px;
    background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.95), rgba(255,0,255,0.7));
    border-radius: 50%;
    box-shadow: 0 0 25px rgba(255,0,255,0.6), inset 0 0 10px rgba(255,255,255,0.3);
    animation: blink 6s infinite;
  }

  @keyframes blink {
    0%, 90%, 100% { transform: scaleY(1); }
    95% { transform: scaleY(0.1); }
  }

  /* Mouth */
  #percy-mouth {
    position: absolute;
    bottom: 23%;
    left: 50%;
    width: 110px;
    height: 22px;
    transform: translateX(-50%) scaleY(1);
    background: radial-gradient(circle at 50% 50%, rgba(255,150,255,0.8), rgba(255,0,200,0.3));
    border-radius: 0 0 60px 60px;
    box-shadow: 0 0 18px rgba(255,0,255,0.5);
    transition: transform 0.1s ease-in-out;
  }
</style>

  <!-- Percy core (leave your existing percy.js if needed) -->
  <script src="js/percy.js?v=6.4"></script>

  <script>
  /* =====================================================
     AI HEAD DRAW + CAMERA + UI glue
     - Animated head reacts to Percy.PartEE.awarenessLevel /
       PercyState.selfMeta.insightLevel when available
     - Keeps camera face/object detection active (BlazeFace + Coco)
     - Removed visualizer + puppeteer panel to make room
     ===================================================== */

      // outer glow ring to emphasize state
      ctx.beginPath();
      ctx.arc(cx, cy, radius*1.35, 0, Math.PI*2);
      ctx.lineWidth = Math.max(2, radius*0.018);
      ctx.strokeStyle = `hsla(${hue}, ${sat}%, ${clamp(light+6,20,96)}%, ${glowAlpha})`;
      ctx.stroke();
    }

    let lastFrame = 0;
    function animate(now) {
      // sample awareness and smooth it
      const target = getAwareness();
      lastAw = lerp(lastAw, target, 0.06);
      // small breathing effect
      const breath = 0.02 * (0.8 + 0.2 * Math.sin(Date.now() / 400));
      lastAw = clamp(lastAw + breath, 0, 1);

      drawHead(lastAw);
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    // --- Camera + models (kept code, compact) ---
    const video = document.getElementById('camera-feed');
    const overlay = document.getElementById('camera-overlay');
    const overlayCtx = overlay.getContext('2d');

    let cocoModel = null, faceModel = null;
    function resizeOverlayToVideo(){
      if(!video || !overlay) return;
      const vidW = video.videoWidth || video.clientWidth || 640;
      const vidH = video.videoHeight || video.clientHeight || 480;
      overlay.width = vidW;
      overlay.height = vidH;
      overlay.style.width = video.clientWidth + 'px';
      overlay.style.height = video.clientHeight + 'px';
    }

    async function initModelsAndStream(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        await video.play();
        resizeOverlayToVideo();
        window.addEventListener('resize', resizeOverlayToVideo);

        // load models (concurrently)
        const loadPromises = [];
        loadPromises.push(cocoSsd.load().then(m=> cocoModel = m));
        loadPromises.push(blazeface.load().then(m=> faceModel = m));
        await Promise.all(loadPromises);

        // detection loop
        detectLoop();
        appendConsole('‚úÖ Camera + models ready', 'exec');
      } catch (err) {
        appendConsole('‚ö†Ô∏è Camera/models init failed: ' + (err.message || err), 'exec');
        console.error(err);
      }
    }

    async function detectLoop(){
      if(video.readyState < 2){ requestAnimationFrame(detectLoop); return; }
      resizeOverlayToVideo();

      overlayCtx.clearRect(0,0,overlay.width,overlay.height);
      try {
        const [objects, faces] = await Promise.all([
          cocoModel ? cocoModel.detect(video) : Promise.resolve([]),
          faceModel ? faceModel.estimateFaces(video, false) : Promise.resolve([])
        ]);

        const scaleX = overlay.width / video.videoWidth;
        const scaleY = overlay.height / video.videoHeight;

        for(const obj of (objects||[])){
          const [x,y,w,h] = obj.bbox;
          const bx = x * scaleX, by = y * scaleY, bw = w * scaleX, bh = h * scaleY;
          overlayCtx.strokeStyle = 'rgba(0,255,255,0.9)';
          overlayCtx.lineWidth = 2;
          overlayCtx.strokeRect(bx, by, bw, bh);
          overlayCtx.fillStyle = 'rgba(0,255,255,0.18)';
          overlayCtx.fillRect(bx, by, bw, bh);
          overlayCtx.fillStyle = 'rgba(255,255,255,0.95)';
          overlayCtx.font = '12px monospace';
          overlayCtx.fillText(`${obj.class} (${Math.round(obj.score*100)}%)`, bx+6, by+14);
        }

        for(const face of (faces||[])){
          const [x1, y1] = face.topLeft;
          const [x2, y2] = face.bottomRight;
          const fx = x1 * scaleX, fy = y1 * scaleY;
          const w = (x2 - x1) * scaleX, h = (y2 - y1) * scaleY;
          overlayCtx.strokeStyle = 'rgba(255,0,255,0.9)';
          overlayCtx.lineWidth = 1.8;
          overlayCtx.strokeRect(fx, fy, w, h);
          overlayCtx.fillStyle = 'rgba(255,0,255,0.18)';
          overlayCtx.fillRect(fx, fy, w, h);
          overlayCtx.fillStyle = '#00ff66';
          overlayCtx.beginPath();
          overlayCtx.arc(fx + w/2, fy + h/2, 3, 0, Math.PI*2);
          overlayCtx.fill();
        }

        // forward to Percy hook if exists
        if(typeof Percy.onVisualInput === 'function'){
          Percy.onVisualInput({ objects, faces });
        }
      } catch(e){
        // console.warn('detectLoop error', e);
      }
      requestAnimationFrame(detectLoop);
    }

    // small UI helper to append to the console (kept)
    const percyConsole = document.getElementById('percy-console');
    function appendConsole(text, cls) {
      const el = document.createElement('div');
      el.className = 'console-line' + (cls ? ' ' + cls : '');
      el.textContent = text;
      percyConsole.appendChild(el);
      percyConsole.scrollTop = percyConsole.scrollHeight;
      console.log(text);
    }

    // Start models + camera on user gesture (autoplay policies)
    window.addEventListener('load', () => {
      // allow camera init to wait for explicit user interaction in some browsers
      // but attempt now
      setTimeout(initModelsAndStream, 500);
    });

    // --- Interpreter & Exec & Chat glue (kept) ---
    (function(){
      const interp = document.getElementById('interpreter-input');
      const ask = document.getElementById('askPercyButton');
      ask.addEventListener('click', runInterp);
      interp.addEventListener('keydown', e => { if(e.key==='Enter') runInterp(); });
      function runInterp(){
        const q = interp.value.trim();
        if(!q) return;
        appendConsole('‚Ü≥ ' + q, 'ask');
        let resp = '‚öôÔ∏è Percy core not available';
        if(typeof Percy.interpret === 'function') {
          try{ resp = Percy.interpret(q); }catch(e){ resp = '‚ö† Interpreter error'; }
        } else if(typeof percyRespond === 'function') {
          try{ resp = percyRespond(q); }catch(e){ resp = '‚ö† percyRespond error'; }
        }
        appendConsole(resp);
        interp.value = '';
      }
    })();

    // Exec (math quick evaluator)
    (function(){
      const execInput = document.getElementById('percy-exec-input');
      const execRun = document.getElementById('percy-exec-run');

      execRun.addEventListener('click', handleExec);
      execInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); handleExec(); } });

      function safeEvalMath(expr){
        const ok = /^[0-9+\-*/%().\s^]+$/.test(expr);
        if(!ok) throw new Error('Expression contains invalid characters');
        const sanitized = expr.replace(/\^/g, '**');
        return Function('"use strict"; return (' + sanitized + ')')();
      }

      async function handleExec(){
        const q = execInput.value.trim();
        if(!q) return;
        appendConsole('‚Ü≥ ' + q, 'ask');
        try {
          // try math first, else pass to PercyState tool
          try {
            const result = safeEvalMath(q);
            appendConsole('üßÆ Math: ' + String(result), 'exec');
          } catch (eMath) {
            // not math: attempt to call Percy.exec or PercyState.useTool if present
            if(window.Percy?.exec){
              const res = await Percy.exec('tool', q);
              appendConsole('ü§ñ ' + (res || 'Executed via Percy.exec'), 'exec');
            } else if(window.PercyState?.useTool){
              const res = await PercyState.useTool('tools', q);
              appendConsole('ü§ñ ' + (res || 'Executed via PercyState.useTool'), 'exec');
            } else {
              appendConsole('‚ö†Ô∏è No executor available.', 'exec');
            }
          }
        } catch(err){
          appendConsole('‚ö†Ô∏è Exec error: ' + (err.message || err), 'exec');
        }
        execInput.value = '';
      }
    })();

    // Chat box
    (function(){
      const input = document.getElementById('percy-chat-input');
      const send = document.getElementById('percy-chat-send');
      const messages = document.getElementById('percy-chat-messages');

      send.addEventListener('click', sendMsg);
      input.addEventListener('keydown', e => { if(e.key==='Enter') sendMsg(); });

      function appendMsg(role, text){
        const d = document.createElement('div');
        d.style.margin = '6px 0';
        d.textContent = role + ': ' + text;
        d.style.color = role === 'Percy' ? '#9fffb0' : '#cfe8ff';
        messages.appendChild(d);
        messages.scrollTop = messages.scrollHeight;
      }

      function sendMsg(){
        const t = input.value.trim();
        if(!t) return;
        appendMsg('You', t);
        input.value = '';
        let resp = '‚öôÔ∏è Percy offline';
        if(Percy?.PartT?.hear) resp = Percy.PartT.hear(t);
        else if(Percy?.interpret) resp = Percy.interpret(t);
        else if(typeof percyRespond === 'function') resp = percyRespond(t);
        appendMsg('Percy', resp);
      }
    })();

  })();
  </script>
</body>
</html>
