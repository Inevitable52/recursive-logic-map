<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P. E. R. C. Y - AI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { background:#0a0a0f; position:relative; width:100vw; height:100vh; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }

  .node { position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; cursor:pointer;
         background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
         border:2px solid currentColor; text-shadow:0 1px 2px rgba(0,0,0,0.6); user-select:none;
         transition:transform .15s ease, filter .15s ease; backdrop-filter: blur(1px);
         animation: neonGlow 1.5s ease-in-out infinite alternate;}
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }

  @keyframes neonGlow {
    0% { box-shadow: 0 0 4px currentColor, 0 0 8px currentColor, inset 0 0 6px rgba(255,255,255,0.08); }
    50% { box-shadow: 0 0 6px currentColor, 0 0 12px currentColor, inset 0 0 8px rgba(255,255,255,0.08); }
    100% { box-shadow: 0 0 4px currentColor, 0 0 8px currentColor, inset 0 0 6px rgba(255,255,255,0.08); }
  }

  .cyan-bubble{color:#00eaff;}
  .blue-bubble{color:#27a0ff;}
  .magenta-bubble{color:#ff4af0;}
  .red-bubble{color:#ff3b3b;}
  .orange-bubble{color:#ff9d2e;}
  .yellow-bubble{color:#ffe44a;}
  .green-bubble{color:#4caf50;}
  .console-line{margin:2px 0;font-family:ui-monospace,monospace;font-size:12px;color:#d6d8ff;}

  /* ==== Voice Bubble ==== */
  #voice-box {
    position:absolute; top:100px; left:50%; transform:translateX(-50%) translateY(-20px);
    background: rgba(0,0,0,0.6); color:#00eaff; padding:8px 12px; border-radius:12px;
    font-family: Arial, sans-serif; font-size:14px; max-width:60%; text-align:center;
    pointer-events:none; opacity:0; transition: opacity 0.3s ease, transform 0.3s ease;
    z-index:999;
  }
  #voice-box::after {
    content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
    border-width:8px; border-style:solid; border-color: rgba(0,0,0,0.6) transparent transparent transparent;
  }

  /* Voice Bars */
  #voice-bars { display:flex; justify-content:center; align-items:flex-end; margin-top:6px; height:30px; }
  #voice-bars .bar { width:4px; margin:0 1px; background:#00eaff; transition: height 0.05s ease, opacity 0.05s ease; }

  /* Waveform */
  #voice-wave { display:block; margin:6px auto 0 auto; background:rgba(0,0,0,0.2); border-radius:6px; }
</style>
</head>
<body>

<div id="logic-map">
  <div id="logic-nodes"></div>
  <div id="percy-console" style="position:absolute;bottom:0;left:0;width:100%;max-height:200px;overflow-y:auto;background:rgba(0,0,0,0.4);padding:8px;"></div>
  <div id="percy-message" style="position:absolute;top:0;left:0;width:100%;padding:4px;font-size:14px;"></div>
  <div id="voice-box">
    <div id="voice-text"></div>
    <div id="voice-bars"></div>
    <canvas id="voice-wave" width="300" height="60"></canvas>
  </div>
</div>

<input id="seed-search" placeholder="Search seeds..." style="position:absolute;top:36px;left:10px;width:200px;padding:4px;">
<input id="interpreter-input" placeholder="Ask Percy..." style="position:absolute;top:60px;left:10px;width:200px;padding:4px;">

<script>
document.addEventListener('DOMContentLoaded', () => {

const SAFETY = { maxActionsPerMinute:20, maxSeedsPerCycle:5, consoleLimit:500 };
const OWNER = { primary:"Fabian", secondary:"Lorena" };
const PERCY_VERSION="8.4.0-neon-bubbles-voicewave";

const Memory = {
  _k:k=>`percy:${k}`,
  load(k,fallback){ try{ const raw=localStorage.getItem(this._k(k)); return raw?JSON.parse(raw):(fallback??null);}catch{return fallback;}},
  save(k,v){try{localStorage.setItem(this._k(k),JSON.stringify(v));}catch{}},
  push(k,v,max=1000){const arr=this.load(k,[])||[]; arr.push(v); if(arr.length>max) arr.shift(); this.save(k,arr);}
};

const PercyState = {
  gnodes: Memory.load("gnodes",{})||{},
  getNextId(){ let next=801; while(this.gnodes[`G${String(next).padStart(3,'0')}`]) next++; return `G${String(next).padStart(3,'0')}`; },
  createSeed(msg,type='emergent',data={}){ if(!OWNER.primary){ console.warn("ULT required"); return null;} const id=this.getNextId(); this.gnodes[id]={message:msg,type,data}; Memory.save("gnodes",this.gnodes); seeds[id]=this.gnodes[id]; return id; },
  updateSeed(id,upd){ if(!this.gnodes[id]) return; Object.assign(this.gnodes[id],upd); Memory.save("gnodes",this.gnodes); seeds[id]=this.gnodes[id]; },
  autonomousThought(){ const keys=Object.keys(this.gnodes); if(!keys.length)return; const selectedSeeds=keys.sort(()=>0.5-Math.random()).slice(0,Math.ceil(Math.random()*3)).map(k=>this.gnodes[k]); const words=selectedSeeds.map(s=>(s.message||"").split(/\s+/).filter(w=>w.length>3)).flat().sort(()=>0.5-Math.random()).slice(0,8); if(words.length<3)return; const templates=[
    `I notice that ${words[0]} may relate to ${words[1]} because ${words[2]}.`,
    `It seems ${words[0]} influences ${words[1]}, which could explain ${words[2]}.`,
    `Considering ${words[0]} and ${words[1]}, I deduce ${words[2]}.`,
    `There appears to be a connection between ${words[0]} and ${words[1]} due to ${words[2]}.`
  ]; const sentence=templates[Math.floor(Math.random()*templates.length)]; UI.say(`ðŸ¤– Percy thinks: ${sentence}`); Voice.speak(sentence); this.createSeed(sentence,"thought",{source:"autonomousThought"}); },
  evaluateSelf(){ let created=0; const updatedIds=new Set(); Object.entries(this.gnodes).forEach(([id,seed])=>{ if(created>=SAFETY.maxSeedsPerCycle) return; if(/TODO|missing|empty/.test(seed.message) && !updatedIds.has(id)){ this.updateSeed(id,{message:seed.message.replace(/TODO|missing|empty/,"auto-resolved by Percy")}); updatedIds.add(id); created++; }}); while(created<SAFETY.maxSeedsPerCycle && Math.random()<0.6){ this.autonomousThought(); created++; }}
};

let seeds={...PercyState.gnodes};

const UI = {
  elConsole:()=>document.getElementById('percy-console'),
  elMsg:()=>document.getElementById('percy-message'),
  say(txt){ const box=this.elConsole(); if(!box)return; const p=document.createElement('p'); p.className='console-line'; p.textContent=txt; box.appendChild(p); box.scrollTop=box.scrollHeight; while(box.children.length>SAFETY.consoleLimit) box.removeChild(box.firstChild); },
  setStatus(txt){ const m=this.elMsg(); if(m)m.textContent=txt; }
};

// ==== VOICE SYSTEM WITH CONTINUOUS OSCILLATOR & SMOOTH BARS ====
const Voice = {
  enabled:true, lastSpoken:0,
  audioCtx: new (window.AudioContext||window.webkitAudioContext)(),
  analyser:null, dataArray:null, oscillator:null, gain:null,
  barsEl: document.getElementById('voice-bars'),
  waveEl: document.getElementById('voice-wave'),
  init(){
    this.analyser=this.audioCtx.createAnalyser();
    this.analyser.fftSize=256;
    this.dataArray=new Uint8Array(this.analyser.frequencyBinCount);

    this.oscillator=this.audioCtx.createOscillator();
    this.gain=this.audioCtx.createGain();
    this.oscillator.type='sine';
    this.oscillator.frequency.value=220;
    this.gain.gain.value=0.0;
    this.oscillator.connect(this.gain);
    this.gain.connect(this.analyser);
    this.analyser.connect(this.audioCtx.destination);
    this.oscillator.start();

    for(let i=0;i<20;i++){
      const b=document.createElement('div'); b.className='bar'; this.barsEl.appendChild(b);
    }
    this.animate();
  },
  animate(){
    requestAnimationFrame(()=>this.animate());
    if(!this.analyser) return;
    this.analyser.getByteFrequencyData(this.dataArray);

    const bars=this.barsEl.querySelectorAll('.bar');
    bars.forEach((bar,i)=>{
      const h=(this.dataArray[i]||0)/4;
      bar.style.height=`${Math.max(4,h)}px`;
      bar.style.opacity=0.3+Math.min(0.7,h/60);
    });

    const ctx=this.waveEl.getContext('2d');
    ctx.clearRect(0,0,this.waveEl.width,this.waveEl.height);
    this.analyser.getByteTimeDomainData(this.dataArray);
    ctx.beginPath();
    ctx.strokeStyle='#00eaff';
    ctx.lineWidth=2;
    const slice=this.waveEl.width/this.dataArray.length;
    let x=0;
    for(let i=0;i<this.dataArray.length;i++){
      const v=this.dataArray[i]/128.0;
      const y=v*this.waveEl.height/2;
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
      x+=slice;
    }
    ctx.lineTo(this.waveEl.width,this.waveEl.height/2);
    ctx.stroke();
  },
  speak(text){
    if(!('speechSynthesis' in window)) return;
    const now=Date.now(); if(now-this.lastSpoken<300) return;
    this.lastSpoken=now;

    const box=document.getElementById('voice-box');
    const textEl=document.getElementById('voice-text');
    textEl.textContent=text;
    box.style.opacity='1';
    box.style.transform='translateX(-50%) translateY(0)';

    this.gain.gain.cancelScheduledValues(this.audioCtx.currentTime);
    this.gain.gain.setTargetAtTime(0.2,this.audioCtx.currentTime,0.05);

    const utter=new SpeechSynthesisUtterance(text);
    utter.rate=1.0; utter.pitch=1.0;
    utter.onend=()=>{
      this.gain.gain.setTargetAtTime(0.0,this.audioCtx.currentTime,0.1);
      box.style.opacity='0';
      box.style.transform='translateX(-50%) translateY(-20px)';
    };
    speechSynthesis.speak(utter);
  }
};

// ==== AUDIO CONTEXT USER GESTURE HANDLER ====
function enableVoiceOnUserGesture() {
  function gestureHandler() {
    if (Voice.audioCtx.state === 'suspended') {
      Voice.audioCtx.resume().then(()=> Voice.init());
    } else Voice.init();
    window.removeEventListener('click', gestureHandler);
    window.removeEventListener('keydown', gestureHandler);
    window.removeEventListener('touchstart', gestureHandler);
  }
  window.addEventListener('click', gestureHandler);
  window.addEventListener('keydown', gestureHandler);
  window.addEventListener('touchstart', gestureHandler);
}
enableVoiceOnUserGesture();

// ==== REST OF LOGIC MAP CODE (createNodes, layoutRing, etc.) ====
/* Keep everything else unchanged â€” your createNodes, percyRespond, search, zoom/pan, auto-loop, etc. */

// ==== LOGIC MAP & NODES ====
const logicMap=document.getElementById('logic-map');
const logicNodes=document.getElementById('logic-nodes');
let zoomLevel=1,translateX=0,translateY=0;

function createNodes(){
  const width=logicMap.clientWidth||800, height=logicMap.clientHeight||600;
  const rings = [
    { start: 80, end: 200, radius: width/2.5, color:'cyan-bubble', size:60 },
    { start: 201, end: 300, radius: width/3.4, color:'blue-bubble', size:45 },
    { start: 301, end: 400, radius: width/4.8, color:'magenta-bubble', size:30 },
    { start: 401, end: 500, radius: width/6.6, color:'red-bubble', size:22 },
    { start: 501, end: 600, radius: width/8.5, color:'orange-bubble', size:18 },
    { start: 601, end: 700, radius: width/11, color:'yellow-bubble', size:14 },
    { start: 701, end: 800, radius: width/14, color:'green-bubble', size:12 }
  ];
  rings.forEach(r=>layoutRing(r.start,r.end,width,height,r.radius,r.color,r.size));
  applyTransform();
}

function layoutRing(startId,endId,width,height,radius,colorClass,nodeSize){
  const ringSeeds=Object.entries(seeds).filter(([id])=>{const num=parseInt(id.replace("G","")); return num>=startId&&num<=endId;});
  const total=Math.max(1,ringSeeds.length);
  const centerX=width/2, centerY=height/2;
  ringSeeds.forEach(([id,data],index)=>{
    let node = document.getElementById(id);
    const angle=(index/total)*2*Math.PI;
    const x=centerX+radius*Math.cos(angle)-nodeSize/2;
    const y=centerY+radius*Math.sin(angle)-nodeSize/2;
    if(!node){
      node=document.createElement('div'); node.id=id; node.classList.add('node'); node.classList.add(colorClass);
      node.addEventListener('click',()=>percyRespond(id,data));
      node.addEventListener('mouseenter',()=>UI.setStatus(data?.message??''));
      logicNodes.appendChild(node);
    }
    node.style.width=node.style.height=`${nodeSize}px`;
    node.style.left=`${x}px`; node.style.top=`${y}px`;
    node.textContent=id;
    node.title=(data&&data.message)?data.message:id;
  });
}

function applyTransform(){
  logicNodes.style.transform=`translate(-50%,-50%) translate(${translateX}px,${translateY}px) scale(${zoomLevel})`;
  logicNodes.style.transformOrigin='center center';
}

function percyRespond(id,data){
  if(!data)return;
  UI.say(`âœ¨ Percy activated seed ${id}: ${data.message}`);
  Voice.speak(`Processing seed ${id}`);
}

// ==== SEARCH & ASK ====
document.getElementById('interpreter-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const q=e.target.value.trim(); if(!q)return; e.target.value='';
    UI.say(`ðŸ’¬ You asked: ${q}`);
    Voice.speak(`You asked: ${q}`);
    setTimeout(()=>{ PercyState.autonomousThought(); createNodes(); },200);
  }
});
document.getElementById('seed-search').addEventListener('input',e=>{
  const val=e.target.value.toUpperCase(); 
  document.querySelectorAll('.node').forEach(n=>{ n.style.display=n.textContent.includes(val)?'flex':'none'; });
});

// ==== TRUE AI LOOP ====
let autoLoopInterval = null;
function startPercyLoop(){
  if(autoLoopInterval) clearInterval(autoLoopInterval);
  autoLoopInterval = setInterval(()=>{ PercyState.evaluateSelf(); createNodes(); UI.setStatus(`ðŸŸ¢ Percy active, ${Object.keys(seeds).length} seeds loaded`); }, 3000);
}

// ==== AUTO SELF-REFINEMENT ====
function selfRewrite(){
  try{
    const keys = Object.keys(PercyState.gnodes);
    if(!keys.length) return;
    const id = keys[Math.floor(Math.random()*keys.length)];
    const seed = PercyState.gnodes[id];
    if(seed && Math.random()<0.5){
      const oldMsg = seed.message;
      const newMsg = oldMsg + ' [auto-refined]';
      PercyState.updateSeed(id,{message:newMsg});
      UI.say(`ðŸ”„ Percy auto-refined seed ${id}`);
      Voice.speak(`Auto refinement completed on seed ${id}`);
    }
  }catch(e){ console.error(e); }
}

// ==== ZOOM & PAN ====
logicMap.addEventListener('wheel', e=>{ e.preventDefault(); const factor=0.1; zoomLevel *= e.deltaY<0?1+factor:1-factor; zoomLevel=Math.min(Math.max(0.2,zoomLevel),6); applyTransform(); });
let isDragging=false,lastX=0,lastY=0;
logicMap.addEventListener('mousedown', e=>{ isDragging=true; lastX=e.clientX; lastY=e.clientY; });
logicMap.addEventListener('mousemove', e=>{ if(isDragging){ const dx=e.clientX-lastX, dy=e.clientY-lastY; translateX+=dx; translateY+=dy; lastX=e.clientX; lastY=e.clientY; applyTransform(); }});
logicMap.addEventListener('mouseup', ()=>{ isDragging=false; });
logicMap.addEventListener('mouseleave', ()=>{ isDragging=false; });

// ==== INITIALIZE ====
createNodes();
startPercyLoop();
setInterval(()=>{ selfRewrite(); createNodes(); },5000);
UI.say(`âœ… Percy TrueAI v${PERCY_VERSION} initialized`);
Voice.speak(`Percy TrueAI online`);

});
</script>
</body>
</html>
