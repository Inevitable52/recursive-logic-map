<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
#logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
#logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
.console-line { margin:2px 0; font-family:monospace; font-size:12px; }
.console-line.ask { color:#d6d8ff; }
.console-line.exec { color:#7fff7f; }
#percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
#percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }
#voice-visualizer { position:fixed; top:12px; right:12px; width:360px; height:128px; pointer-events:none; display:flex; align-items:center; border-radius:12px; background:linear-gradient(180deg,rgba(7,7,12,0.6),rgba(7,7,12,0.35)); box-shadow:0 6px 24px rgba(0,255,255,0.08), inset 0 1px 0 rgba(255,255,255,0.02); border:1px solid rgba(0,255,255,0.1); }
#voice-canvas { flex:1; width:100%; height:100%; border-radius:8px; background:linear-gradient(180deg,rgba(0,0,0,0.1),rgba(0,0,0,0.05)); }
#askPercyButton,#percy-exec-run { padding:6px 12px; color:white; border:none; border-radius:6px; cursor:pointer; z-index:9999; }
#askPercyButton { position:fixed; top:12px; left:530px; background:#1a1aff; }
#askPercyButton:hover { background:#3333ff; }
#percy-exec-run { position:fixed; top:90px; left:530px; background:#1aff55; }
#percy-exec-run:hover { background:#33ff77; }
#interpreter-input,#percy-exec-input,#seed-search { position:fixed; padding:6px; z-index:9999; width:300px; }
#seed-search { top:12px; left:12px; width:200px; }
#interpreter-input { top:12px; left:220px; }
#percy-exec-input { top:90px; left:220px; width:300px; }
#exec-toggle { position:fixed; top:50px; left:220px; z-index:9999; }
#exec-toggle button { padding:4px 12px; margin-right:6px; border:none; border-radius:6px; cursor:pointer; background:#333; color:white; }
#exec-toggle button.active { background:#1aff55; color:black; }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="percy-console"></div>
<div id="percy-message"></div>

<input id="seed-search" placeholder="Search seeds">
<input id="interpreter-input" placeholder="Ask Percy">
<button id="askPercyButton">Run</button>

<div id="exec-toggle">
  <button data-mode="math" class="active">Math</button>
  <button data-mode="java">Java</button>
  <button data-mode="percydirect">Percy</button>
</div>

<input id="percy-exec-input" placeholder="Percy Exec (Math/Java/Percy)">
<button id="percy-exec-run">Run Exec</button>

<script src="js/percy.js?v=6.4"></script>

<div id="voice-visualizer"><canvas id="voice-canvas"></canvas></div>

<script>
(function(){
  const interpreterInput = document.getElementById('interpreter-input'),
        percyConsole = document.getElementById('percy-console'),
        askButton = document.getElementById('askPercyButton');

  function appendConsole(text,isUser=false,exec=false){
    const line=document.createElement('div');
    line.className='console-line '+(isUser?'ask':'')+(exec?' exec':'');
    line.textContent=(isUser?'↳ ':'')+text;
    percyConsole.appendChild(line);
    percyConsole.scrollTop = percyConsole.scrollHeight;
  }

  function runPercyCommand(){
    const query = interpreterInput.value.trim();
    if(!query) return;
    appendConsole(query,true);
    let response="";
    if(typeof percyRespond==='function') response=percyRespond(query);
    else if(window.Percy && typeof Percy.interpret==='function') response=Percy.interpret(query);
    if(response){
      appendConsole(response,false,false);
      if(Percy?.speak) Percy.speak(response);
    }
    interpreterInput.value='';
  }

  interpreterInput.addEventListener('keydown',e=>{ if(e.key==='Enter') runPercyCommand(); });
  askButton.addEventListener('click',runPercyCommand);
})();
</script>

<script>
(function(){
  const execInput = document.getElementById('percy-exec-input'),
        execBtn   = document.getElementById('percy-exec-run'),
        consoleDiv = document.getElementById('percy-console'),
        toggleBtns = document.querySelectorAll('#exec-toggle button');

  if(!execInput) return;
  let PercyExecMode = "percydirect"; // default Percy-aware

  toggleBtns.forEach(btn => btn.addEventListener('click', () => {
    toggleBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    PercyExecMode = btn.dataset.mode;
  }));

  async function handleExecInput(){
    const query = execInput.value.trim();
    if(!query) return;
    execInput.value = "";

    const userLine = document.createElement("div");
    userLine.className = "console-line ask";
    userLine.textContent = "↳ " + query;
    consoleDiv.appendChild(userLine);

    let output = "";

    if(PercyExecMode === "percydirect"){
      try {
        if(typeof window.percyRespond === 'function'){
          output = await window.percyRespond(query);
        } else {
          output = "⚠️ Percy logic not loaded.";
        }
      } catch(err){
        output = "⚠️ Error processing Percy command: " + err.message;
      }
    }
    else if(PercyExecMode === "math"){
      output = await PercyState.useTool("math", query);
    }
    else if(PercyExecMode === "java"){
      try {
        const parts = query.split(/;\s*/).filter(p=>p.trim());
        const funcDefs = {};
        let result = "";
        for(const p of parts){
          const m = p.match(/int\s+(\w+)\(([^)]*)\)\s*{\s*return\s+([^}]+);?\s*}/);
          if(m){ funcDefs[m[1]] = new Function(m[2], `return ${m[3]};`); result = `✅ Function ${m[1]} defined`; }
        }
        for(const p of parts){
          const c = p.match(/(\w+)\(([^)]*)\)/);
          if(c) result = funcDefs[c[1]] ? funcDefs[c[1]](...c[2].split(',').map(a=>parseInt(a.trim()))) : `⚠️ Function ${c[1]} not defined`;
        }
        output = result;
      } catch(e){ output = "⚠️ Error executing Java snippet: " + e.message; }
    }

    const percyLine = document.createElement("div");
    percyLine.className = "console-line exec";
    percyLine.textContent = "🤖 " + output;
    consoleDiv.appendChild(percyLine);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }

  execInput.addEventListener("keydown", async e=>{ if(e.key==="Enter"){ e.preventDefault(); await handleExecInput(); } });
  execBtn.addEventListener("click", handleExecInput);
})();
</script>

<script>
(function(){
  const canvas=document.getElementById('voice-canvas'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  function resize(){ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
  resize(); window.addEventListener('resize',resize);

  let audioCtx,analyser,dataFreq,dataWave;

  async function initAudio(){
    if(audioCtx) return;
    try{
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      analyser=audioCtx.createAnalyser(); analyser.fftSize=256;
      dataFreq=new Uint8Array(analyser.frequencyBinCount); dataWave=new Uint8Array(analyser.frequencyBinCount);
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      audioCtx.createMediaStreamSource(stream).connect(analyser);
      draw();
    }catch(e){ console.error("🎤 Microphone access denied:",e); }
  }

  function draw(){
    requestAnimationFrame(draw); if(!analyser) return;
    const W=canvas.width,H=canvas.height;
    ctx.clearRect(0,0,W,H);
    analyser.getByteFrequencyData(dataFreq);
    const barWidth=W/dataFreq.length;
    for(let i=0;i<dataFreq.length;i++){
      const barH=dataFreq[i]/255*H;
      ctx.fillStyle=`rgb(${dataFreq[i]},${255-dataFreq[i]},255)`; ctx.fillRect(i*barWidth,H-barH,barWidth*0.6,barH);
    }
    analyser.getByteTimeDomainData(dataWave);
    ctx.lineWidth=2; ctx.strokeStyle='rgba(0,255,255,0.8)'; ctx.beginPath();
    let x=0, slice=W/dataWave.length;
    for(let i=0;i<dataWave.length;i++){ const y=dataWave[i]/128*H/2; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); x+=slice; }
    ctx.stroke();
  }

  ['click','keydown','touchstart'].forEach(evt=>window.addEventListener(evt,initAudio,{once:true,passive:true}));
})();
</script>

</body>
</html>
