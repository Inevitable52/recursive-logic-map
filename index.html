<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
  .console-line { margin:2px 0; font-family:ui-monospace,Monaco,Consolas, monospace; font-size:12px; color:#d6d8ff; }
  #percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
  #percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }

  /* visualizer (top-right, compact) */
  #voice-visualizer {
    position:fixed;
    top:12px;
    right:12px;
    width:320px;
    height:120px;
    pointer-events:none;
    z-index:9999;
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px;
    box-sizing:border-box;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(7,7,12,0.6), rgba(7,7,12,0.35));
    box-shadow: 0 6px 24px rgba(0,255,255,0.06), inset 0 1px 0 rgba(255,255,255,0.02);
    border:1px solid rgba(0,255,255,0.06);
  }
  #voice-visualizer canvas {
    flex:1;
    height:100%;
    width: calc(100% - 76px);
    display:block;
    border-radius:8px;
    background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06));
  }
  /* bars column */
  #voice-bars {
    width:60px;
    height:100%;
    display:flex;
    flex-direction:column;
    justify-content:flex-end;
    gap:6px;
    align-items:center;
  }
  .vbar {
    width:10px;
    height:12px;
    border-radius:6px;
    background: linear-gradient(to top, #27a0ff, #7efcff);
    box-shadow: 0 0 10px rgba(39,160,255,0.65), 0 0 20px rgba(39,160,255,0.25);
    transition: height 0.06s linear, background 0.06s linear;
    will-change: height;
  }

  @media (max-width:420px){
    #voice-visualizer { right:6px; top:6px; width:260px; height:90px; }
    #voice-bars { width:48px; gap:4px; }
    .vbar { width:8px; }
  }
</style>
</head>
<body>
  <div id="logic-map"><div id="logic-nodes"></div></div>
  <div id="percy-console"></div>
  <div id="percy-message"></div>
  <input id="seed-search" placeholder="Search seeds" style="position:fixed;top:12px;left:12px;padding:6px;width:200px;z-index:9999;">
  <input id="interpreter-input" placeholder="Ask Percy" style="position:fixed;top:12px;left:220px;padding:6px;width:300px;z-index:9999;">

  <!-- existing Percy core (unchanged) -->
  <script src="js/percy.js?v=6.4"></script>

<!-- visualizer (voice synthesizer style) -->
<div id="voice-visualizer" aria-hidden="true">
  <div id="voice-bars" aria-hidden="true">
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
    <div class="vbar"></div>
  </div>
  <canvas id="voice-canvas"></canvas>
</div>

<style>
#voice-visualizer {
  position:fixed;
  top:12px;
  right:12px;
  width:400px;
  height:160px;
  pointer-events:none;
  z-index:9999;
  display:flex;
  flex-direction:column; /* bars on top, wave under */
  gap:6px;
  padding:10px;
  box-sizing:border-box;
  border-radius:14px;
  background: rgba(10,10,20,0.7);
  border:1px solid rgba(0,255,255,0.15);
  box-shadow: 0 6px 24px rgba(0,255,255,0.25);
}
#voice-bars {
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  height:70px;
}
.vbar {
  flex:1;
  margin:0 3px;
  border-radius:4px;
  background: linear-gradient(to top, #ff0080, #00f0ff, #00ff80);
  box-shadow: 0 0 12px rgba(0,255,255,0.9), 0 0 24px rgba(255,0,200,0.6);
  height:12px;
  transition: height 0.1s ease-out;
}
#voice-canvas {
  width:100%;
  height:70px;
  border-radius:8px;
  display:block;
  background:rgba(0,0,0,0.15);
}
</style>

<script>
const canvas = document.getElementById("voice-canvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let isSpeaking = false;
let speakEndTime = 0;
let animationId;
let t = 0;

const bars = document.querySelectorAll(".vbar");

// === trigger ===
function speakAnimation(textLength) {
  const duration = Math.max(2000, textLength * 70);
  isSpeaking = true;
  speakEndTime = Date.now() + duration;
  animateVisualizer();
}

// === draw ===
function animateVisualizer() {
  cancelAnimationFrame(animationId);

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // === synthesizer waveform ===
    ctx.beginPath();
    let mid = canvas.height/2;
    for (let x = 0; x < canvas.width; x++) {
      // mix of sine waves for "synth" look
      let y = mid
        + Math.sin((x+t)/12) * 12
        + Math.sin((x+t)/25) * 8
        + Math.sin((x+t)/50) * 5;
      ctx.lineTo(x, y);
    }
    ctx.strokeStyle = "lime";
    ctx.lineWidth = 2;
    ctx.shadowColor = "cyan";
    ctx.shadowBlur = 20;
    ctx.stroke();

    // === bars movement ===
    bars.forEach((bar, i) => {
      let h = isSpeaking ? 10 + Math.abs(Math.sin(t/5 + i))*60 : 8;
      bar.style.height = `${h}px`;
    });

    if (Date.now() > speakEndTime) {
      isSpeaking = false;
    }

    t += 2;
    animationId = requestAnimationFrame(draw);
  }
  draw();
}

// hook into Voice if present
if (window.Voice) {
  const originalSpeak = Voice.speak.bind(Voice);
  Voice.speak = function(text) {
    speakAnimation(text.length);
    return originalSpeak(text);
  };
} else {
  console.warn("⚠️ Voice not found. Demo running.");
  setTimeout(()=> speakAnimation(50), 2000);
}
</script>
</body>
</html>
