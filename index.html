/* === percy.js (Part H ‚Äî MCP Toolkit Integration) === */
if (typeof PercyState !== 'undefined') {

  // Percy‚Äôs Tool Registry
  PercyState.tools = PercyState.tools || {};

  /**
   * Register a tool for Percy.
   * @param {string} name - Tool name (unique key)
   * @param {function} handler - Function that takes (input, options) and returns a result
   * @param {object} meta - Metadata like description, usage example, etc.
   */
  PercyState.registerTool = function(name, handler, meta={}) {
    if (!name || typeof handler !== 'function') {
      console.error("‚ùå Invalid tool registration:", name);
      return;
    }
    this.tools[name] = { handler, meta };
    UI.say(`üõ†Ô∏è Tool registered: ${name}`);
  };

  /**
   * Call a registered tool.
   * @param {string} name - Tool name
   * @param {any} input - Input for the tool
   * @param {object} options - Extra options/context
   * @returns {any} - Tool result or error
   */
  PercyState.useTool = async function(name, input, options={}) {
    const tool = this.tools[name];
    if (!tool) {
      UI.say(`‚ö†Ô∏è Tool "${name}" not found.`);
      return null;
    }
    try {
      const result = await tool.handler(input, options);
      UI.say(`‚úÖ Tool "${name}" executed.`);
      return result;
    } catch (err) {
      console.error("Tool error:", err);
      UI.say(`‚ùå Tool "${name}" failed: ${err.message}`);
      return null;
    }
  };

  /**
   * List available tools
   */
  PercyState.listTools = function() {
    return Object.keys(this.tools).map(name => ({
      name,
      ...this.tools[name].meta
    }));
  };

  // Example built-in tool: Echo
  PercyState.registerTool("echo", async (input) => {
    return `Echo: ${input}`;
  }, { description: "Repeats back whatever you say." });

  // Example built-in tool: Math Eval (safe)
  PercyState.registerTool("math", async (input) => {
    try {
      const res = Function('"use strict";return (' + input + ')')();
      return res;
    } catch {
      return "‚ö†Ô∏è Invalid math expression.";
    }
  }, { description: "Evaluates simple math expressions safely." });

  UI.say("üîå Percy Part H (MCP Toolkit) loaded.");
} else {
  console.error("‚ùå PercyState not found; cannot load Part H.");
}

// === Add new custom tool: Search Seeds ===
PercyState.registerTool("searchSeeds", async (query) => {
  const seeds = Object.entries(PercyState.gnodes || {});
  const results = seeds.filter(([id, text]) => text.toLowerCase().includes(query.toLowerCase()));
  return results.slice(0, 5).map(([id, text]) => ({ id, text }));
}, { description: "Searches Percy‚Äôs logic map for seeds related to a query." });

 /* === Percy Part H Add-on: Universal Ask Percy Router (Advanced) === */
PercyState.PartH = PercyState.PartH || {};

// --- PercyState.log helper ---
PercyState.log = PercyState.log || function(msg) {
  console.log("[Percy]", msg);
};

// List of math functions Percy will recognize
PercyState.PartH.mathFunctions = ["sin","cos","tan","asin","acos","atan","log","ln","sqrt","abs","exp","pi","e","factorial","d/dx","‚à´","‚àë","^"];

// Helper: Detect math/physics expressions
PercyState.PartH.isMath = function(input) {
  const basicMath = /^[0-9\+\-\*\/\^\(\)\s\.]+$/;
  const advancedMath = new RegExp(PercyState.PartH.mathFunctions.join("|"), "i");
  return basicMath.test(input) || advancedMath.test(input);
};

// Helper: Detect Java code
PercyState.PartH.isJava = function(input) {
  return /class|public|static|void|System\.out|new\s+[A-Z]/i.test(input);
};

// Helper: Detect tool creation command
PercyState.PartH.isToolCommand = function(input) {
  return /^make tool/i.test(input);
};

// Universal input router
PercyState.PartH.routeInput = async function(input) {
  input = input.trim();
  if (!input) return "Please ask something, my good sir.";

  // --- Math / Physics ---
  if (PercyState.PartH.isMath(input)) {
    try {
      let result = await PercyState.useTool("math", input);
      PercyState.log(`üßÆ Math result: ${input} = ${result}`);
      return result;
    } catch (err) {
      PercyState.log("‚ùå Math evaluation failed: " + err.message);
      return "‚ö†Ô∏è Math evaluation failed.";
    }
  }

  // --- Java code ---
  if (PercyState.PartH.isJava(input)) {
    PercyState.log("üìù Java code detected ‚Üí sending to Part F self-rewrite.");
    return PercyState.PartF?.rewriteSelf("H", "Integrate Java snippet", {code: input, apply: false});
  }

  // --- Tool creation ---
  if (PercyState.PartH.isToolCommand(input)) {
    let toolName = input.replace(/^make tool\s*/i, "").trim() || "customTool";
    PercyState.log(`üõ† Creating new tool: ${toolName}`);
    PercyState.registerTool(toolName, async (query) => {
      return `Tool "${toolName}" executed with query: ${query}`;
    }, { description: `Dynamically created tool: ${toolName}`});
    return `‚úÖ Tool "${toolName}" created.`;
  }

  // --- Default / normal Ask Percy ---
  PercyState.log("üí¨ Routing as normal input ‚Üí AutoLearn handles it.");
  if (PercyState.PartI?.autoLearnCycle) {
    return PercyState.PartI.autoLearnCycle(input);
  }
  return Percy.correlateReply ? await Percy.correlateReply(input) : "Processed as thought.";
};

// --- Hook Ask Percy bar & ENTER / RUN ---
PercyState.PartH.hookAskPercy = function() {
  const askBox = document.querySelector("#interpreter-input");
  const runBtn = document.querySelector("#interpreter-run");
  if (!askBox) {
    PercyState.log("‚ö†Ô∏è Ask Percy input not found.");
    return;
  }

  async function handleInput() {
    const query = askBox.value.trim();
    if (!query) return;
    askBox.value = "";
    const output = await PercyState.PartH.routeInput(query);
    
    // Append to console
    const consoleDiv = document.querySelector("#percy-console");
    if (consoleDiv) {
      const userLine = document.createElement("div");
      userLine.className = "console-line";
      userLine.textContent = "‚Ü≥ " + query;
      consoleDiv.appendChild(userLine);

      const percyLine = document.createElement("div");
      percyLine.className = "console-line";
      percyLine.textContent = "ü§ñ " + output;
      consoleDiv.appendChild(percyLine);

      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    try { if (typeof Percy.speak === "function") Percy.speak(output); } catch(e){}
  }

  // ENTER key
  askBox.addEventListener("keydown", async e => {
    if (e.key === "Enter") {
      e.preventDefault();
      await handleInput();
    }
  });

  // RUN button
  if (runBtn) runBtn.addEventListener("click", handleInput);

  PercyState.log("üîó Universal Router hooked into Ask Percy.");
};

// Auto-start after Percy loads
setTimeout(() => PercyState.PartH.hookAskPercy(), 1500);

// --- Add advanced math support to Math tool ---
PercyState.registerTool("math", async (expr) => {
  try {
    // Use Function + Math for safe evaluation
    const fn = new Function("Math", `with(Math){return ${expr}}`);
    return fn(Math);
  } catch {
    return "‚ö†Ô∏è Invalid math/physics expression.";
  }
}, { description: "Evaluates simple and advanced math, physics, trig, calculus formulas." });

UI.say("üîå Percy Part H Add-on (Universal Router + Advanced Math/Code/Tools) loaded.");
