<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percy AI Dashboard</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:absolute; top:0; left:0; width:100vw; height:70vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); width:100%; height:100%; }
  #chat-container { position:absolute; bottom:0; left:0; width:100%; height:30vh; background:#111; overflow-y:auto; padding:8px; box-sizing:border-box; }
  #chat-container p { margin:2px 0; font-family: monospace; font-size:13px; color:#d6d8ff; }
  #input-container { position:absolute; bottom:0; width:100%; display:flex; }
  #user-input { flex:1; padding:8px; border:none; outline:none; font-size:14px; }
  #send-btn { padding:8px 12px; background:#3764ff; color:white; border:none; cursor:pointer; }
  .node{ position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-weight:700; color:#fff; cursor:pointer;
    background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
    border:2px solid currentColor;
    box-shadow: 0 0 6px currentColor, 0 0 14px currentColor, inset 0 0 12px rgba(255,255,255,0.08);
    text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    user-select:none; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; backdrop-filter: blur(1px);}
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="chat-container"></div>
<div id="input-container">
  <input type="text" id="user-input" placeholder="Ask Percy something..." />
  <button id="send-btn">Send</button>
</div>

<script src="./js/percy.js"></script>
<script>
const chatBox = document.getElementById('chat-container');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

// Helper: show message with typing effect
function typeMessage(sender, msg, speed=25){
    const p = document.createElement('p');
    p.textContent = `${sender}: `;
    chatBox.appendChild(p);
    let i=0;
    function typeNext(){
        if(i<msg.length){
            p.textContent += msg[i];
            i++;
            chatBox.scrollTop = chatBox.scrollHeight;
            setTimeout(typeNext, speed);
        }
    }
    typeNext();
}

// Hook Percy
function enablePercyAutonomy() {
    if(!window.PercyState) return;

    PercyState.autonomousQueue = PercyState.autonomousQueue || [];

    // Add some test autonomous thoughts
    PercyState.autonomousQueue.push("Hello! I am Percy, your AI companion.");
    PercyState.autonomousQueue.push("I can speak, think, and even rewrite my own logic safely.");

    // Override speak to show typing
    const originalSpeak = PercyState.speak;
    PercyState.speak = function(msg){
        typeMessage('ðŸ¤– Percy', msg);
        if(typeof originalSpeak==='function') originalSpeak.call(PercyState,msg);
    }

    // Safe code updating
    PercyState.getCode = PercyState.getCode || async function(){
        const response = await fetch('./js/percy.js');
        return await response.text();
    }

    PercyState.rewriteCode = PercyState.rewriteCode || function(code){
        let newCode = code;
        newCode = newCode.replace(/([^\s;{}])\n/g,"$1;\n");
        newCode = newCode.replace(/function (\w+)\(\)\s*{\s*}/g,"function $1(){\n  // TODO: Implement $1\n}");
        if(!newCode.includes('// Percy auto-optimized')){
            newCode += `\n// Percy auto-optimized at ${new Date().toLocaleTimeString()}`;
        }
        return newCode;
    }

    PercyState.updateCode = PercyState.updateCode || function(newCode){
        try{
            let oldScript = document.querySelector('script[data-percy-self]');
            if(oldScript) oldScript.remove();

            const blob = new Blob([newCode], {type:'text/javascript'});
            const url = URL.createObjectURL(blob);

            const newScript = document.createElement('script');
            newScript.src = url;
            newScript.setAttribute('data-percy-self','true');
            document.body.appendChild(newScript);
        }catch(e){
            PercyState.speak("Error updating code: "+e.message);
        }
    }

    // Autonomous loop
    async function autonomousLoop(){
        while(true){
            // Speak thoughts
            if(PercyState.autonomousQueue.length){
                const thought = PercyState.autonomousQueue.shift();
                PercyState.speak(thought);
            }

            // Rewrite code if allowed
            if(PercyState.canRewriteCode){
                try{
                    const code = await PercyState.getCode();
                    const newCode = PercyState.rewriteCode(code);
                    PercyState.updateCode(newCode);
                    PercyState.speak("I've improved my own logic autonomously!");
                }catch(e){
                    PercyState.speak("Error rewriting code: "+e.message);
                }
            }

            await new Promise(r=>setTimeout(r,10000));
        }
    }
    autonomousLoop();
}

// Enable Percy autonomy
enablePercyAutonomy();

// Send message from user
sendBtn.addEventListener('click',()=>{
    const msg = input.value.trim();
    if(!msg) return;
    typeMessage('You', msg);
    input.value='';
    if(window.PercyState){
        const id = PercyState.createSeed(msg,'userInput');
        const seed = PercyState.gnodes[id];
        const response = seed?.message || "Hmm, I have no reply yet.";
        PercyState.speak(response);
    }
});

// Send on Enter
input.addEventListener('keydown', e=>{
    if(e.key==='Enter') sendBtn.click();
});
</script>
</body>
</html>
