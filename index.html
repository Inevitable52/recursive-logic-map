<!-- Percy Script -->
<script src="js/percy.js?v=6.4"></script>
<script>
  // Safely make percyRespond callable from HTML without redeclaring anything
  if(window.Percy === undefined) window.Percy = {};
  if(typeof window.Percy.percyRespond !== "function" && typeof percyRespond === "function") {
    window.Percy.percyRespond = percyRespond;
  }

  // Seed Search
  const searchInput = document.getElementById('seed-search');
  searchInput.addEventListener('input', ()=> {
    const val = searchInput.value.trim().toUpperCase();
    document.querySelectorAll('.node').forEach(n=>{
      n.style.display = (!val || n.textContent.toUpperCase().includes(val)) ? 'flex' : 'none';
    });
  });

  // Ask Percy
  const askInput = document.getElementById('ask-input');
  const askBtn = document.getElementById('ask-btn');
  askBtn.addEventListener('click', () => {
    if(askInput.value.trim() && typeof window.Percy.percyRespond === "function") {
      window.Percy.percyRespond('User', {message: askInput.value});
      askInput.value='';
    }
  });
  askInput.addEventListener('keydown', e => { if(e.key==='Enter') askBtn.click(); });

  // === Voice Visualizer ===
  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 64;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  // Bars
  const bars = document.querySelectorAll('.bar');
  function animateBars(){
    analyser.getByteFrequencyData(dataArray);
    bars.forEach((bar,i)=>{
      bar.style.height = (dataArray[i % bufferLength]/255*60 + 20) + 'px';
    });
    requestAnimationFrame(animateBars);
  }

  // Sinewave Canvas
  const canvas = document.getElementById('sinewave');
  const ctx = canvas.getContext('2d');
  function resizeCanvas(){ canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight; }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function animateSinewave(){
    requestAnimationFrame(animateSinewave);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    analyser.getByteFrequencyData(dataArray);
    ctx.beginPath();
    for(let i=0;i<canvas.width;i++){
      const v = dataArray[i % bufferLength]/255;
      const y = canvas.height/2 + Math.sin(i*0.05+Date.now()*0.003)*v*30;
      ctx.lineTo(i,y);
    }
    ctx.strokeStyle = '#27a0ff';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // Connect Microphone
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream=>{
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    animateBars();
    animateSinewave();
  }).catch(()=>console.warn("Microphone access denied"));
</script>
