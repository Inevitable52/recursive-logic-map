<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percy + Audio Visualizer</title>
<style>
  body {
    margin:0; 
    background:#111; 
    color:white; 
    overflow:hidden;
    font-family:Arial,sans-serif;
  }
  #logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #visualizer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  canvas { width:100%; height:100%; display:block; }
  .node { /* existing Percy node styles */ }
  .console-line { font-family: monospace; font-size:12px; color:#d6d8ff; }
</style>
</head>
<body>
<div id="logic-map">
  <canvas id="visualizer"></canvas>
  <div id="logic-nodes"></div>
</div>
<div id="percy-console" style="position:absolute; bottom:0; left:0; width:100%; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.6);"></div>

<script src="percy.js"></script> <!-- your Percy parts A-C -->

<script>
(async function() {
  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // Setup Audio
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  // Get microphone
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
  } catch(e) {
    console.error("Microphone access denied", e);
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    analyser.getByteFrequencyData(dataArray);

    const barWidth = (canvas.width / bufferLength) * 2.5;
    let x = 0;

    // Draw bars
    for(let i=0; i<bufferLength; i++){
      const barHeight = dataArray[i];
      const hue = i * 2;
      ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
      ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
      x += barWidth + 1;
    }

    // Draw sinewave
    analyser.getByteTimeDomainData(dataArray);
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#00ffff';
    ctx.beginPath();
    const sliceWidth = canvas.width / bufferLength;
    let px = 0;
    for(let i=0; i<bufferLength; i++){
      const v = dataArray[i] / 128.0 - 1.0; // normalize -1 to 1
      const y = canvas.height/2 + v * canvas.height/4;
      if(i===0) ctx.moveTo(px, y);
      else ctx.lineTo(px, y);
      px += sliceWidth;
    }
    ctx.stroke();

    requestAnimationFrame(draw);
  }

  draw();
})();
</script>
</body>
</html>