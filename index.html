<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Percy TrueAI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
  .console-line { margin:2px 0; font-family:ui-monospace,Monaco,Consolas, monospace; font-size:12px; color:#d6d8ff; }
  #percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
  #percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }
  /* visualizer canvas will cover screen */
  #voice-visualizer canvas { width:100%; height:100%; display:block; }
</style>
</head>
<body>
  <div id="logic-map"><div id="logic-nodes"></div></div>
  <div id="percy-console"></div>
  <div id="percy-message"></div>
  <input id="seed-search" placeholder="Search seeds" style="position:fixed;top:12px;left:12px;padding:6px;width:200px;z-index:9999;">
  <input id="interpreter-input" placeholder="Ask Percy" style="position:fixed;top:12px;left:220px;padding:6px;width:300px;z-index:9999;">

  <!-- ✅ Load working Percy core -->
  <script src="js/percy.js?v=6.4"></script>

  <!-- ✅ Add just the visualizer -->
  <script>
  (function(){
    const visContainer = document.createElement('div');
    visContainer.id = 'voice-visualizer';
    visContainer.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:60;';
    document.body.appendChild(visContainer);

    const canvas = document.createElement('canvas');
    visContainer.appendChild(canvas);
    const ctx = canvas.getContext('2d');

    function resizeCanvas(){
      const w = visContainer.clientWidth;
      const h = visContainer.clientHeight;
      const ratio = window.devicePixelRatio || 1;
      canvas.width = Math.max(1, Math.floor(w * ratio));
      canvas.height = Math.max(1, Math.floor(h * ratio));
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(ratio,0,0,ratio,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 512;
    const freqData = new Uint8Array(analyser.frequencyBinCount);
    const waveData = new Uint8Array(analyser.fftSize);

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 220;
    gain.gain.value = 0.03;
    osc.connect(gain);
    gain.connect(analyser);
    analyser.connect(audioCtx.destination);
    osc.start();

    // Hook Percy’s voice
    const originalSpeak = (window.Voice && Voice.speak) ? Voice.speak.bind(Voice) : ()=>{};
    if(window.Voice && typeof Voice.speak === 'function'){
      Voice.speak = function(text){
        try { originalSpeak(text); } catch(e){}
        if(audioCtx.state === 'suspended'){ audioCtx.resume(); }
        const now = audioCtx.currentTime;
        gain.gain.cancelScheduledValues(now);
        gain.gain.setValueAtTime(gain.gain.value, now);
        gain.gain.linearRampToValueAtTime(0.18, now + 0.02);
        gain.gain.linearRampToValueAtTime(0.03, now + 0.3);
      };
    }

    function draw(){
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(freqData);
      analyser.getByteTimeDomainData(waveData);

      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // Bars
      const bars = freqData.length;
      const barWidth = w / bars;
      for(let i=0;i<bars;i++){
        const v = freqData[i]/255;
        const barH = v * (h*0.6);
        ctx.fillStyle = `hsl(${200+v*120},80%,55%)`;
        ctx.fillRect(i*barWidth, h-barH, barWidth*0.9, barH);
      }

      // Wave
      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgba(255,255,255,0.9)';
      for(let i=0;i<waveData.length;i++){
        const x = (i/waveData.length)*w;
        const y = ((waveData[i]/255 - 0.5) * h * 1.8) + h/2;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
    draw();
  })();
  </script>
</body>
</html>
