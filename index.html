<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>P.E.R.C.Y - AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --bg:#0a0a0f; --neon-a:#00ffff; --neon-b:#ff00ff; --accent:#1aff55; }
  html,body{height:100%;margin:0;background:var(--bg);color:#e8eefc;font-family:Consolas,monospace;overflow:hidden}
  #logic-map{position:relative;width:100vw;height:100vh;background:#090912}
  #logic-nodes{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
  /* console / ui */
  #percy-console{position:fixed;left:0;bottom:0;width:34%;max-height:40%;overflow:auto;padding:10px;background:rgba(0,0,0,0.6);border-top-right-radius:12px;border:1px solid #222;z-index:9998}
  .console-line{font-size:12px;margin:4px 0;font-family:monospace}
  .console-line.ask{color:#cfe8ff}
  .console-line.exec{color:#9fffb0}
  #percy-message{position:fixed;left:34%;bottom:0;width:66%;padding:10px;background:rgba(0,0,0,0.6);border-top-left-radius:12px;border:1px solid #222;z-index:9997}
  /* header inputs */
  input,textarea,button{font-family:monospace}
  #seed-search{position:fixed;top:12px;left:12px;width:200px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:9999}
  #interpreter-input{position:fixed;top:12px;left:220px;width:300px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:9999}
  #askPercyButton{position:fixed;top:12px;left:530px;padding:6px 12px;border-radius:6px;background:#1a1aff;color:#fff;border:none;cursor:pointer;z-index:9999}
  #askPercyButton:hover{background:#3333ff}
  #exec-toggle{position:fixed;top:50px;left:220px;z-index:9999}
  #exec-toggle button{padding:4px 12px;margin-right:6px;border-radius:6px;border:0;background:#333;color:#fff;cursor:pointer}
  #exec-toggle button.active{background:var(--accent);color:#000}
  #percy-exec-input{position:fixed;top:90px;left:220px;width:300px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:9999}
  #percy-exec-run{position:fixed;top:90px;left:530px;padding:6px 12px;border-radius:6px;border:0;background:var(--accent);color:#000;cursor:pointer;z-index:9999}
  /* camera */
  #camera-feed{position:fixed;top:150px;right:12px;width:480px;height:360px;border-radius:16px;border:2px solid var(--neon-a);box-shadow:0 0 18px var(--neon-a),0 0 36px var(--neon-b);background:#000;object-fit:cover;z-index:1200;transition:transform .25s}
  #camera-feed:hover{transform:scale(1.03)}
  #camera-overlay{position:fixed;top:150px;right:12px;width:480px;height:360px;pointer-events:none;z-index:1300}
  /* voice visualizer */
  #voice-visualizer{position:fixed;top:12px;right:12px;width:360px;height:128px;border-radius:12px;background:linear-gradient(180deg,rgba(7,7,12,0.6),rgba(7,7,12,0.35));box-shadow:0 6px 24px rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.08);z-index:9999;display:flex;align-items:center;justify-content:center}
  #voice-canvas{width:100%;height:100%;border-radius:8px;background:transparent}
  /* puppeteer + chat area (center-bottom) */
  #puppeteer-control{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-220px); /* place to the left of center */
    width:420px;
    max-width:46vw;
    background:rgba(0,0,0,0.8);
    border-radius:12px;
    padding:10px;
    border:1px solid rgba(255,255,255,0.06);
    box-shadow: 0 6px 30px rgba(0,0,0,0.6), 0 0 18px var(--neon-a);
    z-index:1300;
    color:#e8eefc;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #puppeteer-control .title{font-family:monospace;font-size:13px;opacity:0.9}
  /* chat */
  #percy-chat-box{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(40px); /* sit just right of puppeteer-control */
    width:340px;
    height:400px;
    background:rgba(0,0,0,0.75);
    border-radius:12px;
    border:1px solid #222;
    display:flex;
    flex-direction:column;
    z-index:1350;
    box-shadow:0 8px 30px rgba(0,0,0,0.6), 0 0 18px var(--neon-b);
  }
  #percy-chat-messages{flex:1;padding:8px;overflow:auto}
  #percy-chat-input{flex:1;padding:6px;border:0;background:#111;color:#fff}
  #percy-chat-send{padding:6px 10px;border:0;background:var(--accent);color:#000;cursor:pointer;border-radius:6px}
  /* small responsive */
  @media (max-width:900px){
    #camera-feed{width:360px;height:270px}
    #camera-overlay{width:360px;height:270px}
    /* stack puppeteer + chat vertically on small screens */
    #puppeteer-control{ transform: translateX(-50%); left:50%; width:320px; bottom:140px; }
    #percy-chat-box{ transform: translateX(-50%); left:50%; bottom:20px; width:320px; }
  }
</style>
</head>
<body>

  <div id="logic-map"><div id="logic-nodes"></div></div>

  <div id="percy-console" aria-live="polite"></div>
  <div id="percy-message"></div>

  <input id="seed-search" placeholder="Search seeds" />
  <input id="interpreter-input" placeholder="Ask Percy" />
  <button id="askPercyButton">Run</button>

  <div id="exec-toggle">
    <button data-mode="math" class="active">Math</button>
    <button data-mode="java">Java</button>
    <button data-mode="tools">Tools</button>
  </div>

  <textarea id="percy-exec-input" rows="3" placeholder="Percy Exec (Math/Java/Tools)"></textarea>
  <button id="percy-exec-run">Run Exec</button>

  <!-- Camera + overlay -->
  <video id="camera-feed" autoplay muted playsinline></video>
  <canvas id="camera-overlay"></canvas>

  <!-- voice visualizer -->
  <div id="voice-visualizer"><canvas id="voice-canvas"></canvas></div>

  <!-- CENTER-BOTTOM: Puppeteer control (added) -->
  <div id="puppeteer-control" role="region" aria-label="Puppeteer control">
    <div class="title">‚òï Puppeteer</div>
  </div>

  <!-- chat (now positioned to the right of puppeteer-control) -->
  <div id="percy-chat-box">
    <div id="percy-chat-messages"></div>
    <div style="display:flex;border-top:1px solid #222;padding:6px;">
      <input id="percy-chat-input" placeholder="Talk to Percy..." />
      <button id="percy-chat-send">Send</button>
    </div>
  </div>

  <!-- TF models -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>

  <!-- Percy core (leave your existing percy.js if needed) -->
  <script src="js/percy.js?v=6.4"></script>

  <script>
  
  /* =====================================================
     PartZ ‚Äî Camera, vision models, audio visualizer, ASI
     ===================================================== */
  PartZ.init = async function(){
  try {
    // use enhanced audio constraints to prevent feedback hum
    const stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: false
      }
    });

    // connect video stream, but mute output
    video.srcObject = stream;
    video.muted = true;
    await video.play();
    resizeOverlayToVideo();
    window.addEventListener('resize', resizeOverlayToVideo);

    // audio setup (visualizer only, no playback)
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    dataFreq = new Uint8Array(analyser.frequencyBinCount);
    dataWave = new Uint8Array(analyser.frequencyBinCount);
    const srcNode = audioCtx.createMediaStreamSource(stream);
    srcNode.connect(analyser);
    // do NOT connect to destination -> prevents hum
    PartZ.analyser = analyser;

    // lazy resume on user interaction (for autoplay policy)
    ['click','keydown','touchstart'].forEach(ev => {
      const once = async () => {
        try { if (audioCtx.state === 'suspended') await audioCtx.resume(); } catch(e){}
        window.removeEventListener(ev, once);
      };
      window.addEventListener(ev, once, {passive:true});
    });

    // init models + detection loop
    await initModels();
    detect();

    // start voice visualizer
    const vc = document.getElementById('voice-canvas');
    startAudioVisualizer(vc);

    appendConsole('‚úÖ PartZ initialized (hum fix applied)', 'exec');
  } catch(err){
    console.error('PartZ init failed', err);
    appendConsole('‚ö†Ô∏è PartZ init failed: ' + (err.message||err), 'exec');
  }
};

    /* detection loop */
    async function detect(){
  if(video.readyState < 2){ requestAnimationFrame(detect); return; }

  const [objects, faces] = await Promise.all([
    cocoModel.detect(video),
    faceModel.estimateFaces(video, false)
  ]);

  overlayCtx.clearRect(0,0,overlay.width,overlay.height);

  const scaleX = overlay.width / video.videoWidth;
  const scaleY = overlay.height / video.videoHeight;

  // Object detection boxes
  for(const obj of objects){
    const [x,y,w,h] = obj.bbox;
    const bx = x * scaleX, by = y * scaleY, bw = w * scaleX, bh = h * scaleY;

    overlayCtx.strokeStyle = 'rgba(0,255,255,0.9)';
    overlayCtx.lineWidth = 2;
    overlayCtx.strokeRect(bx, by, bw, bh);
    overlayCtx.fillStyle = 'rgba(0,255,255,0.5)';
    overlayCtx.font = '12px monospace';
    overlayCtx.fillText(`${obj.class} (${Math.round(obj.score*100)}%)`, bx+4, by+12);
    console.log(`üü¶ Object: ${obj.class} (${Math.round(obj.score*100)}%)`);
  }

  // Face detection boxes
  for(const face of faces){
    const [x1, y1] = face.topLeft;
    const [x2, y2] = face.bottomRight;
    const w = (x2 - x1) * scaleX;
    const h = (y2 - y1) * scaleY;
    const fx = x1 * scaleX, fy = y1 * scaleY;
    const cx = fx + w / 2, cy = fy + h / 2;

    overlayCtx.strokeStyle = 'rgba(255,0,255,0.9)';
    overlayCtx.lineWidth = 2;
    overlayCtx.shadowColor = '#ff00ff';
    overlayCtx.shadowBlur = 12;
    overlayCtx.strokeRect(fx, fy, w, h);
    overlayCtx.shadowBlur = 0;

    overlayCtx.fillStyle = 'rgba(255,0,255,0.3)';
    overlayCtx.font = '12px monospace';
    overlayCtx.fillText('Face', fx + 4, fy + 12);

    overlayCtx.beginPath();
    overlayCtx.arc(cx, cy, 3, 0, 2 * Math.PI);
    overlayCtx.fillStyle = '#00ff66';
    overlayCtx.fill();

    console.log(`üéØ Face detected at (${Math.round(cx)},${Math.round(cy)})`);
  }

  if(typeof Percy.onVisualInput === 'function'){
    Percy.onVisualInput({objects, faces});
  }

  requestAnimationFrame(detect);
}

    /* audio visualizer combined -> sine + bars */
    function startAudioVisualizer(canvas){
      const ctxV = canvas.getContext('2d');
      function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
      resize(); window.addEventListener('resize', resize);

      (function draw(){
        requestAnimationFrame(draw);
        if(!analyser) return;
        analyser.getByteFrequencyData(dataFreq);
        analyser.getByteTimeDomainData(dataWave);

        const W = canvas.width, H = canvas.height;
        ctxV.clearRect(0,0,W,H);

        // bars (frequency)
        const barCount = dataFreq.length;
        const barW = Math.max(1, W / barCount);
        for(let i=0;i<barCount;i++){
          const v = dataFreq[i] / 255;
          const h = v * H * 0.5;
          ctxV.fillStyle = `rgb(${dataFreq[i]},${255-dataFreq[i]},255)`;
          ctxV.fillRect(i*barW, H - h, barW * 0.7, h);
        }

        // sine waveform overlaid
        ctxV.lineWidth = 2;
        ctxV.strokeStyle = 'rgba(0,255,255,0.95)';
        ctxV.beginPath();
        const slice = W / dataWave.length;
        let x = 0;
        for(let i=0;i<dataWave.length;i++){
          const v = (dataWave[i] - 128) / 128; // -1..1
          const y = H/2 + v * (H*0.22);
          if(i===0) ctxV.moveTo(x,y); else ctxV.lineTo(x,y);
          x += slice;
        }
        ctxV.stroke();
      })();
    }

  /* =====================================================
     Percy.ASI (simple task queue)
     ===================================================== */
  Percy.ASI = (function(){
    const ASI = { taskQueue: [], running:false };
    ASI.addTask = function(task){ if(task && typeof task.exec==='function') ASI.taskQueue.push(task); };
    ASI.runNext = async function(){
      if(ASI.running) return;
      const t = ASI.taskQueue.shift();
      if(!t) return;
      ASI.running = true;
      try{ const res = await t.exec(); if(typeof t.onComplete==='function') t.onComplete(res); }catch(e){ console.error('ASI task error', e); }
      ASI.running = false;
      setTimeout(ASI.runNext, 0);
    };
    ASI.loop = function(){ setTimeout(ASI.loop, 200); ASI.runNext(); };
    ASI.init = function(){ console.log('‚úÖ Percy.ASI initialized'); ASI.loop(); };
    return ASI;
  })();

  /* =====================================================
     Hook visual input into ASI
     ===================================================== */
  Percy.onVisualInput = Percy.onVisualInput || function(data){
    if(data.objects && data.objects.length) {
      Percy.ASI.addTask({ exec: async ()=>{ console.log('üü¶ Objects:', data.objects.map(o=>o.class).join(', ')); return data.objects; } });
    }
    if(data.faces && data.faces.length) {
      Percy.ASI.addTask({ exec: async ()=>{ console.log('üí† Faces detected:', data.faces.length); return data.faces.length; }});
    }
  };

  /* =====================================================
     Console / Exec / Chat UI glue
     ===================================================== */
  // small UI helpers
  const percyConsole = document.getElementById('percy-console');
  function appendConsole(text,cls){
    const el = document.createElement('div');
    el.className = 'console-line' + (cls? ' ' + cls : '');
    el.textContent = text;
    percyConsole.appendChild(el);
    percyConsole.scrollTop = percyConsole.scrollHeight;
    // also log to F12
    console.log(text);
  }

  // interpreter input
  (function(){
    const interp = document.getElementById('interpreter-input');
    const ask = document.getElementById('askPercyButton');
    ask.addEventListener('click', runInterp);
    interp.addEventListener('keydown', e => { if(e.key==='Enter') runInterp(); });
    function runInterp(){
      const q = interp.value.trim();
      if(!q) return;
      appendConsole('‚Ü≥ ' + q, 'ask');
      let resp = '‚öôÔ∏è Percy core not available';
      if(typeof Percy.interpret === 'function') {
        try{ resp = Percy.interpret(q); }catch(e){ resp = '‚ö† Interpreter error'; }
      } else if(typeof percyRespond === 'function') {
        try{ resp = percyRespond(q); }catch(e){ resp = '‚ö† percyRespond error'; }
      }
      appendConsole(resp);
      interp.value = '';
    }
  })();

  // Percy Exec (math quick evaluator)
  (function(){
    const execInput = document.getElementById('percy-exec-input');
    const execRun = document.getElementById('percy-exec-run');
    const modeBtns = document.querySelectorAll('#exec-toggle button');

    modeBtns.forEach(b=>b.addEventListener('click', ()=>{ modeBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); }));

    execRun.addEventListener('click', handleExec);
    execInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); handleExec(); } });

    function safeEvalMath(expr){
      // whitelist characters: digits, spaces, parentheses and arithmetic operators
      const ok = /^[0-9+\-*/%().\s^]+$/.test(expr);
      if(!ok) throw new Error('Expression contains invalid characters');
      // convert ^ to ** for exponent if present
      const sanitized = expr.replace(/\^/g, '**');
      // Use Function to evaluate after validation
      // eslint-disable-next-line no-new-func
      return Function('"use strict"; return (' + sanitized + ')')();
    }

        async function handleExec(){
      const q = execInput.value.trim();
      if(!q) return;
      appendConsole('‚Ü≥ ' + q, 'ask');

      const mode = document.querySelector('#exec-toggle button.active')?.dataset?.mode || 'math';

      try {
        if(mode === 'math'){
          const result = safeEvalMath(q);
          appendConsole('üßÆ Math: ' + String(result), 'exec');
          console.log('üßÆ Exec result:', result);
        } 
        else if(mode === 'java') {
          appendConsole('‚öôÔ∏è Sending Java code to Percy...', 'exec');
          if(window.Percy?.exec){
            const res = await Percy.exec('java', q);
            appendConsole('ü§ñ ' + (res || 'Java executed successfully.'), 'exec');
          } 
          else if(window.PercyState?.useTool){
            const res = await PercyState.useTool('java', q);
            appendConsole('ü§ñ ' + (res || 'Java tool executed.'), 'exec');
          } 
          else {
            appendConsole('‚ö†Ô∏è No Java executor available.', 'exec');
          }
        } 
        else if(mode === 'tools') {
          appendConsole('‚öôÔ∏è Running tool mode...', 'exec');
          if(window.PercyState?.useTool){
            const res = await PercyState.useTool('tools', q);
            appendConsole('ü§ñ ' + (res || 'Tool executed.'), 'exec');
          } else {
            appendConsole('‚ö†Ô∏è No tool executor available.', 'exec');
          }
        }
      } catch(err){
        appendConsole('‚ö†Ô∏è Exec error: ' + err.message, 'exec');
      }

      execInput.value = '';
    }
  })();

  // chat box
  (function(){
    const input = document.getElementById('percy-chat-input');
    const send = document.getElementById('percy-chat-send');
    const messages = document.getElementById('percy-chat-messages');

    send.addEventListener('click', sendMsg);
    input.addEventListener('keydown', e => { if(e.key==='Enter') sendMsg(); });

    function appendMsg(role, text){
      const d = document.createElement('div');
      d.style.margin = '6px 0';
      d.textContent = role + ': ' + text;
      d.style.color = role === 'Percy' ? '#9fffb0' : '#cfe8ff';
      messages.appendChild(d);
      messages.scrollTop = messages.scrollHeight;
    }

    function sendMsg(){
      const t = input.value.trim();
      if(!t) return;
      appendMsg('You', t);
      input.value = '';
      // basic reply flow
      let resp = '‚öôÔ∏è Percy offline';
      if(Percy?.PartT?.hear) resp = Percy.PartT.hear(t);
      else if(Percy?.interpret) resp = Percy.interpret(t);
      else if(typeof percyRespond === 'function') resp = percyRespond(t);
      appendMsg('Percy', resp);
    }
  })();

  /* start everything when page loaded */
  window.addEventListener('load', () => {
    try {
      Percy.PartZ.init();
      Percy.ASI.init();
    } catch(e) { console.error(e); }
  });
  </script>
</body>
</html>
