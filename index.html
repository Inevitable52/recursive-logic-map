<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Percy TrueAI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
  .node {
    position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-weight:700; color:#fff; cursor:pointer;
    background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
    border:2px solid currentColor;
    box-shadow:0 0 6px currentColor, 0 0 14px currentColor, inset 0 0 12px rgba(255,255,255,0.08);
    text-shadow: 0 1px 2px rgba(0,0,0,0.6); user-select:none;
    transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    backdrop-filter: blur(1px);
  }
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }
  .cyan-bubble{color:#00eaff;} .blue-bubble{color:#27a0ff;} .magenta-bubble{color:#ff4af0;}
  .red-bubble{color:#ff3b3b;} .orange-bubble{color:#ff9d2e;} .yellow-bubble{color:#ffe44a;} .green-bubble{color:#4aff7b;}
  .console-line { margin:2px 0; font-family:ui-monospace,Monaco,Consolas, monospace; font-size:12px; color:#d6d8ff; }
  #percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
  #percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }
  #voice-visualizer { position:fixed; bottom:0; right:0; width:200px; height:80px; z-index:9999; background:rgba(0,0,0,0.25); border:1px solid #444; border-radius:8px; }
</style>
</head>
<body>
<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="percy-console"></div>
<div id="percy-message"></div>
<input id="seed-search" placeholder="Search seeds" style="position:fixed;top:12px;left:12px;padding:6px;width:200px;z-index:9999;">
<input id="interpreter-input" placeholder="Ask Percy" style="position:fixed;top:12px;left:220px;padding:6px;width:300px;z-index:9999;">
<canvas id="voice-visualizer"></canvas>

<script>
/* =========================
Percy Memory & State (Part A)
========================= */
const PERCY_ID="Percy-ULT",PERCY_VERSION="8.3.3-neon-bubbles-voice (merged)";
const OWNER={primary:"Fabian",secondary:"Lorena"};
const SAFETY={maxActionsPerMinute:20,maxSeedsPerCycle:5,requirePermissionFor:["externalFetch","openTab","writeDisk","emailLike"],consoleLimit:500};

const Memory={_k:k=>`percy:${k}`,load(k,fallback){try{const r=localStorage.getItem(this._k(k));return r?JSON.parse(r):fallback??null}catch{return fallback;}},save(k,v){try{localStorage.setItem(this._k(k),JSON.stringify(v));}catch{}},push(k,v,max=1e3){const arr=this.load(k,[])||[];arr.push(v);if(arr.length>max)arr.shift();this.save(k,arr);}}; 
const PercyState={ gnodes:Memory.load("gnodes",{})||{},
  getNextId(){let n=801;while(this.gnodes[`G${String(n).padStart(3,'0')}`])n++;return `G${String(n).padStart(3,'0')}`;},
  createSeed(message,type='emergent',data={}){if(!OWNER.primary)return null;const id=this.getNextId();this.gnodes[id]={message,type,data};Memory.save("gnodes",this.gnodes);if(typeof seeds!=='undefined')seeds[id]=this.gnodes[id];if(typeof UI!=='undefined'&&UI.say)UI.say(`✨ Percy created new seed ${id}: ${message}`);if(typeof refreshNodes==='function')refreshNodes();return id;},
  updateSeed(id,update){if(!this.gnodes[id]){if(typeof UI!=='undefined'&&UI.say)UI.say(`⚠ Cannot update: ${id} not found`);return;}Object.assign(this.gnodes[id],update);Memory.save("gnodes",this.gnodes);if(typeof seeds!=='undefined')seeds[id]=this.gnodes[id];if(typeof UI!=='undefined'&&UI.say)UI.say(`🔧 Percy updated seed ${id}`);if(typeof refreshNodes==='function')refreshNodes();},
  autonomousThought(){const keys=Object.keys(this.gnodes);if(!keys.length)return;const selected=keys.sort(()=>0.5-Math.random()).slice(0,Math.ceil(Math.random()*3)).map(k=>this.gnodes[k]);const words=selected.map(s=>(s.message||"").split(/\s+/).filter(w=>w.length>3)).flat().sort(()=>0.5-Math.random()).slice(0,8);if(words.length<3)return;const templates=[`I notice that ${words[0]} may relate to ${words[1]} because ${words[2]}.`,`It seems ${words[0]} influences ${words[1]}, which could explain ${words[2]}.`,`Considering ${words[0]} and ${words[1]}, I deduce ${words[2]}.`,`There appears to be a connection between ${words[0]} and ${words[1]} due to ${words[2]}.`];const sentence=templates[Math.floor(Math.random()*templates.length)];if(typeof UI!=='undefined'&&UI.say)UI.say(`🤖 Percy thinks: ${sentence}`);if(typeof Voice!=='undefined'&&Voice.speak)Voice.speak(sentence);this.createSeed(sentence,"thought",{source:"autonomousThought"});},
  evaluateSelf(){let created=0,updatedIds=new Set();Object.entries(this.gnodes).forEach(([id,seed])=>{if(created>=SAFETY.maxSeedsPerCycle)return;if(/TODO|missing|empty/.test(seed.message)&&!updatedIds.has(id)){this.updateSeed(id,{message:seed.message.replace(/TODO|missing|empty/,"auto-resolved by Percy")});updatedIds.add(id);created++;}});while(created<SAFETY.maxSeedsPerCycle&&Math.random()<0.6){this.autonomousThought();created++;}}
};
let seeds={};

/* =========================
UI & Voice (Part B)
========================= */
const UI={ elConsole:()=>document.getElementById('percy-console'), elMsg:()=>document.getElementById('percy-message'),
  say(txt){const b=this.elConsole();if(!b)return;const p=document.createElement('p');p.className='console-line';p.textContent=txt;b.appendChild(p);b.scrollTop=b.scrollHeight;const max=SAFETY.consoleLimit;while(b.children.length>max)b.removeChild(b.firstChild);},
  setStatus(txt){const m=this.elMsg();if(m)m.textContent=txt;},
  confirmModal({title,body,allowLabel="Allow",denyLabel="Deny"}){return new Promise(resolve=>{const wrap=document.createElement('div');wrap.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:99999";const card=document.createElement('div');card.style.cssText="background:#0b0b12;color:#eee;max-width:520px;width:92%;border:1px solid #444;border-radius:16px;padding:16px 18px;box-shadow:0 6px 32px rgba(0,0,0,.5)";card.innerHTML=`<h3 style="margin:0 0 8px 0;font-size:18px;">${title}</h3><div style="font-size:14px;opacity:.9;margin-bottom:12px;white-space:pre-wrap">${body}</div><div style="display:flex;gap:8px;justify-content:flex-end"><button id="deny" style="padding:8px 12px;border-radius:10px;background:#252535;border:1px solid #3a3a50;color:#ddd">${denyLabel}</button><button id="allow" style="padding:8px 12px;border-radius:10px;background:#3764ff;border:1px solid #2a4de0;color:white">${allowLabel}</button></div>`;wrap.appendChild(card);document.body.appendChild(wrap);card.querySelector('#allow').onclick=()=>{document.body.removeChild(wrap);resolve(true);};card.querySelector('#deny').onclick=()=>{document.body.removeChild(wrap);resolve(false);};});}
};

const Voice = { enabled: true, lastSpoken: 0, speak(text) {
    try {
      if (!this.enabled || !('speechSynthesis' in window) || !text) return;
      const now = Date.now(); if (now - this.lastSpoken < 300) return; this.lastSpoken = now;
      const u = new SpeechSynthesisUtterance(text);
      const pick = v => v.find(v => /en(-|_|$)/i.test(v.lang)) || v[0];
      const ensureVoice = () => {
        const vs = speechSynthesis.getVoices();
        if (vs?.length) { u.voice = pick(vs); speechSynthesis.speak(u); } 
        else { speechSynthesis.onvoiceschanged = () => { const v2 = speechSynthesis.getVoices(); u.voice = pick(v2); speechSynthesis.speak(u); }; }
      };
      u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
      ensureVoice();
    } catch(e) {}
  }
};

/* =========================
Voice Visualizer Hook
========================= */
const canvas = document.getElementById('voice-visualizer');
const ctx = canvas.getContext('2d');
let animating = false;

function animateVisualizer(simData){
    const cw = canvas.width = canvas.clientWidth;
    const ch = canvas.height = canvas.clientHeight;
    ctx.clearRect(0,0,cw,ch);
    const total = simData.length;
    const barWidth = cw / total * 2.5;
    let x = 0;
    for(let i=0; i<total; i++){
        const v = simData[i];
        const y = v*ch;
        ctx.fillStyle = `hsl(${i/total*360},100%,50%)`;
        ctx.fillRect(x, ch-y, barWidth, y);
        x += barWidth + 1;
    }
}

function startFakeVisualizer(duration=1000){
    if(animating) return;
    animating = true;
    const start = Date.now();
    function step(){
        const now = Date.now();
        if(now - start > duration){ animating=false; return; }
        const data = Array.from({length:64},()=>Math.random());
        animateVisualizer(data);
        requestAnimationFrame(step);
    }
    step();
}

const originalSpeak = Voice.speak.bind(Voice);
Voice.speak = function(text){
    if(!text) return;
    const duration = Math.max(1000, text.length*120);
    startFakeVisualizer(duration);
    originalSpeak(text);
};

/* =========================
Logic Nodes & Layout
========================= */
const logicMap=document.getElementById('logic-map'),logicNodes=document.getElementById('logic-nodes');
let zoomLevel=1,translateX=0,translateY=0;
function applyTransform(){logicNodes.style.transform=`translate(-50%,-50%) translate(${translateX}px,${translateY}px) scale(${zoomLevel})`;logicNodes.style.transformOrigin='center center';document.querySelectorAll('.node').forEach(n=>n.style.fontSize=`${12*(1/zoomLevel)}px`);}
function percyRespond(id,data){const msg=typeof data==='string'?data:(data?.message??'');UI.say(`↳ ${msg}`);UI.setStatus(msg);Voice.speak(msg);}
function refreshNodes(){createNodes();UI.say(`🔄 Logic map refreshed with ${Object.keys(seeds).length} seeds`);}
</script>

<script>
/* =========================
Percy Part C: Self-mod, Rings, Autonomy, Interactive Ask
========================= */

if(typeof PercyState!=='undefined'){

  PercyState.rewriteSelf=function({codeChanges}){if(!Array.isArray(codeChanges)||!codeChanges.length){UI.say("⚠ Percy rewriteSelf: no codeChanges provided");return;}codeChanges.forEach(({find,replace})=>{try{const scripts=Array.from(document.querySelectorAll('script')).filter(s=>s.textContent.includes('PercyState'));if(!scripts.length)throw new Error("Cannot locate Percy script for rewrite");scripts.forEach(tag=>{tag.textContent=tag.textContent.replace(find,replace);});UI.say("✅ Percy rewriteSelf applied successfully");}catch(e){UI.say(`❌ Percy rewriteSelf error: ${e.message}`);}});};

  window.percyAsk=async function(promptText){if(!promptText)return null;return new Promise(resolve=>{const r=window.prompt(`🤖 Percy asks:\n${promptText}`);resolve(r);});};

  UI.say("🧩 Percy Part C (self-mod + interactive) loaded.");

  function createNodes(){
    logicNodes.innerHTML='';
    const width=logicMap.clientWidth||800,height=logicMap.clientHeight||600;
    layoutRing(80,200,width,height,width/2.5,'cyan-bubble',60);
    layoutRing(201,300,width,height,width/3.4,'blue-bubble',45);
    layoutRing(301,400,width,height,width/4.8,'magenta-bubble',30);
    layoutRing(401,500,width,height,width/6.6,'red-bubble',22);
    layoutRing(501,600,width,height,width/8.5,'orange-bubble',18);
    layoutRing(601,700,width,height,width/11,'yellow-bubble',14);
    layoutRing(701,800,width,height,width/14,'green-bubble',12);
    applyTransform();
  }

  function layoutRing(startId,endId,width,height,radius,colorClass,nodeSize){
    const ringSeeds=Object.entries(seeds).filter(([id])=>{const n=parseInt(id.slice(1));return n>=startId&&n<=endId;});
    const total=ringSeeds.length||(endId-startId+1);
    for(let i=0;i<total;i++){
      const angle=(i/total)*2*Math.PI;
      const x=width/2 + radius*Math.cos(angle) - nodeSize;
      const y=height/2 + radius*Math.sin(angle) - nodeSize;
      const node=document.createElement('div');
      node.className=`node ${colorClass}`;
      node.style.width=node.style.height=nodeSize+'px';
      const seedId=`G${String(startId+i).padStart(3,'0')}`;
      node.textContent=seedId;
      node.style.left=x+'px'; node.style.top=y+'px';
      node.onclick=()=>{const seed=seeds[seedId];if(seed)percyRespond(seedId,seed);else UI.say(`⚠ ${seedId} not found.`);};
      logicNodes.appendChild(node);
    }
  }

  async function startAutonomyLoop(){
    while(true){
      PercyState.evaluateSelf();
      await new Promise(r=>setTimeout(r,Math.floor(2000+Math.random()*4000)));
    }
  }
  startAutonomyLoop();

  document.getElementById('seed-search').addEventListener('input',e=>{
    const q=e.target.value.toUpperCase();Array.from(logicNodes.children).forEach(n=>{
      n.style.display=n.textContent.includes(q)?'flex':'none';
    });
  });
  document.getElementById('interpreter-input').addEventListener('keydown',async e=>{
    if(e.key==='Enter'){const r=await window.percyAsk(e.target.value);if(r)UI.say(`↳ ${r}`);e.target.value='';}
  });

  UI.say(`✅ Percy TrueAI v${PERCY_VERSION} fully loaded.`);
}
</script>
</body>
</html>
