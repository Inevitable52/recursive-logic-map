<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
  body {
    margin: 0;
    font-family: "Consolas", monospace;
    background: #0a0a0f;
    color: white;
    overflow: hidden;
  }
  #logic-map {
    position: relative;
    width: 100vw;
    height: 100vh;
    background: #090910;
  }
  #logic-nodes { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); }

  /* Console and Exec UI */
  #percy-console {
    position: fixed; bottom: 0; left: 0; width: 35%; max-height: 40%;
    overflow: auto; background: rgba(0,0,0,0.65);
    padding: 6px; border-top-right-radius: 12px; border: 1px solid #333;
  }
  .console-line { margin: 2px 0; font-size: 12px; }
  .console-line.ask { color: #aaf; }
  .console-line.exec { color: #7fff7f; }

  #percy-message {
    position: fixed; bottom: 0; left: 35%; width: 65%;
    padding: 6px; background: rgba(0,0,0,0.65); border-top-left-radius: 12px; border: 1px solid #333;
  }

  /* Buttons and Inputs */
  input, textarea, button {
    font-family: monospace;
    border-radius: 6px;
  }
  #seed-search { position: fixed; top: 12px; left: 12px; width: 200px; padding: 6px; }
  #interpreter-input { position: fixed; top: 12px; left: 220px; width: 300px; padding: 6px; }
  #askPercyButton {
    position: fixed; top: 12px; left: 530px;
    padding: 6px 12px; background: #1a1aff; color: white; border: none; cursor: pointer;
  }
  #askPercyButton:hover { background: #3333ff; }

  #exec-toggle { position: fixed; top: 50px; left: 220px; }
  #exec-toggle button {
    background: #333; color: white; padding: 4px 12px; margin-right: 6px; cursor: pointer; border: none;
  }
  #exec-toggle button.active { background: #1aff55; color: black; }

  #percy-exec-input { position: fixed; top: 90px; left: 220px; width: 300px; padding: 6px; }
  #percy-exec-run {
    position: fixed; top: 90px; left: 530px; background: #1aff55;
    color: black; border: none; padding: 6px 12px; cursor: pointer;
  }

  /* Voice visualizer */
  #voice-visualizer {
    position: fixed; top: 12px; right: 12px;
    width: 360px; height: 128px; border-radius: 12px;
    display: flex; align-items: center;
    background: linear-gradient(180deg, rgba(7,7,12,0.6), rgba(7,7,12,0.35));
    box-shadow: 0 0 24px rgba(0,255,255,0.08);
    border: 1px solid rgba(0,255,255,0.15);
  }

  /* Percy Camera Feed */
  #camera-feed {
    position: fixed; top: 150px; right: 12px;
    width: 480px; height: 360px;
    border-radius: 16px; border: 2px solid #00ffff;
    box-shadow: 0 0 20px #00ffff, 0 0 40px #ff00ff;
    background: rgba(0, 0, 0, 0.25);
    object-fit: cover;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #camera-feed:hover {
    transform: scale(1.05);
    box-shadow: 0 0 30px #00ffff, 0 0 60px #ff00ff;
  }
  #camera-overlay {
    position: fixed; top: 150px; right: 12px;
    width: 480px; height: 360px; pointer-events: none;
  }

  /* Chat Box */
  #percy-chat-box {
    position: fixed; bottom: 50px; right: 12px;
    width: 320px; height: 400px;
    background: rgba(0,0,0,0.8);
    border: 1px solid #333; border-radius: 12px;
    display: flex; flex-direction: column; overflow: hidden;
  }
  #percy-chat-messages { flex: 1; padding: 8px; overflow-y: auto; }
  #percy-chat-input { flex: 1; padding: 6px; border: none; background: #111; color: white; }
  #percy-chat-send { padding: 6px 10px; background: #1aff55; color: black; border: none; cursor: pointer; }

</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="percy-console"></div>
<div id="percy-message"></div>

<input id="seed-search" placeholder="Search seeds">
<input id="interpreter-input" placeholder="Ask Percy">
<button id="askPercyButton">Run</button>

<div id="exec-toggle">
  <button data-mode="math" class="active">Math</button>
  <button data-mode="java">Java</button>
  <button data-mode="tools">Tools</button>
</div>

<textarea id="percy-exec-input" placeholder="Percy Exec (Math/Java/Tools)" rows="4"></textarea>
<button id="percy-exec-run">Run Exec</button>

<!-- Camera + Overlay -->
<video id="camera-feed" autoplay muted playsinline></video>
<canvas id="camera-overlay"></canvas>

<!-- Voice Visualizer -->
<div id="voice-visualizer"><canvas id="voice-canvas"></canvas></div>

<!-- Percy Chat -->
<div id="percy-chat-box">
  <div id="percy-chat-messages"></div>
  <div style="display:flex; border-top:1px solid #333;">
    <input id="percy-chat-input" type="text" placeholder="Talk to Percy...">
    <button id="percy-chat-send">Send</button>
  </div>
</div>

<!-- TensorFlow Models -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<!-- Percy Core -->
<script src="js/percy.js?v=6.4"></script>

<script>
Percy.PartZ = (function(){
  const PartZ = {};
  const video = document.getElementById('camera-feed');
  const overlay = document.getElementById('camera-overlay');
  const ctx = overlay.getContext('2d');

  let analyser=null, audioCtx=null, dataFreq=null;
  PartZ.analyser=null;

  function resizeOverlay(){
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
  }

  async function initModels(){
    console.log("üîç Loading models...");
    const [cocoModel, faceModel] = await Promise.all([
      cocoSsd.load(),
      blazeface.load()
    ]);
    console.log("‚úÖ Coco-SSD + BlazeFace loaded");

    async function detect(){
      if(video.readyState < 2){ requestAnimationFrame(detect); return; }

      const [objects, faces] = await Promise.all([
        cocoModel.detect(video),
        faceModel.estimateFaces(video, false)
      ]);

      ctx.clearRect(0,0,overlay.width,overlay.height);

      // Object detection
      for(const obj of objects){
        const [x,y,w,h]=obj.bbox;
        ctx.strokeStyle='rgba(0,255,255,0.9)';
        ctx.lineWidth=2;
        ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='rgba(0,255,255,0.5)';
        ctx.font='12px monospace';
        ctx.fillText(`${obj.class} (${Math.round(obj.score*100)}%)`, x+4, y+12);
        console.log(`üü¶ Object: ${obj.class} (${Math.round(obj.score*100)}%)`);
      }

      // Face detection
      for(const face of faces){
        const [x1,y1]=face.topLeft;
        const [x2,y2]=face.bottomRight;
        const w=x2-x1, h=y2-y1;
        const cx=x1+w/2, cy=y1+h/2;

        ctx.strokeStyle='rgba(255,0,255,0.9)';
        ctx.lineWidth=2;
        ctx.shadowColor='#ff00ff';
        ctx.shadowBlur=12;
        ctx.strokeRect(x1,y1,w,h);
        ctx.shadowBlur=0;

        ctx.fillStyle='rgba(255,0,255,0.3)';
        ctx.font='12px monospace';
        ctx.fillText('Face', x1+4, y1+12);

        ctx.beginPath();
        ctx.arc(cx,cy,3,0,2*Math.PI);
        ctx.fillStyle='#00ff66';
        ctx.fill();

        console.log(`üéØ Face detected at (${Math.round(cx)},${Math.round(cy)})`);
      }

      if(typeof Percy.onVisualInput === 'function'){
        Percy.onVisualInput({objects, faces});
      }

      requestAnimationFrame(detect);
    }

    detect();
  }

  PartZ.init = async function(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      video.srcObject = stream;
      await video.play();
      resizeOverlay();
      window.addEventListener('resize',resizeOverlay);

      // Audio setup
      audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      analyser=audioCtx.createAnalyser();
      analyser.fftSize=256;
      dataFreq=new Uint8Array(analyser.frequencyBinCount);
      const src=audioCtx.createMediaStreamSource(stream);
      src.connect(analyser);
      PartZ.analyser=analyser;

      await initModels();
    }catch(err){ console.error("PartZ init error",err); }
  };

  return PartZ;
})();

/* === Percy.ASI Integration === */
Percy.ASI = (function(){
  const ASI={queue:[],running:false};
  ASI.addTask=t=>ASI.queue.push(t);
  ASI.runNext=async()=>{
    if(ASI.running||!ASI.queue.length) return;
    ASI.running=true;
    const t=ASI.queue.shift();
    try{ await t.exec(); }catch(e){ console.error(e); }
    ASI.running=false; requestAnimationFrame(ASI.runNext);
  };
  ASI.loop=()=>{ ASI.runNext(); requestAnimationFrame(ASI.loop); };
  ASI.init=()=>{ console.log("‚úÖ ASI ready"); ASI.loop(); };
  return ASI;
})();

/* === Hook visual input === */
Percy.onVisualInput = function(data){
  if(data.objects?.length>0)
    Percy.ASI.addTask({exec:()=>console.log("üß© Objects:", data.objects.map(o=>o.class).join(", "))});
  if(data.faces?.length>0)
    Percy.ASI.addTask({exec:()=>console.log("üí† Faces detected:", data.faces.length)});
};

window.addEventListener('load',()=>{ Percy.PartZ.init(); Percy.ASI.init(); });
</script>

</body>
</html>
