<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P. E. R. C. Y - AI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:absolute; top:0; left:0; width:100vw; height:70vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); width:100%; height:100%; }
  #chat-container { position:absolute; bottom:0; left:0; width:100%; height:30vh; background:#111; overflow-y:auto; padding:8px; box-sizing:border-box; }
  #chat-container p { margin:2px 0; font-family: monospace; font-size:13px; color:#d6d8ff; }
  #input-container { position:absolute; bottom:0; width:100%; display:flex; }
  #user-input { flex:1; padding:8px; border:none; outline:none; font-size:14px; }
  #send-btn { padding:8px 12px; background:#3764ff; color:white; border:none; cursor:pointer; }
  .node{ position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-weight:700; color:#fff; cursor:pointer;
    background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
    border:2px solid currentColor;
    box-shadow: 0 0 6px currentColor, 0 0 14px currentColor, inset 0 0 12px rgba(255,255,255,0.08);
    text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    user-select:none; transition: transform .15s ease, box-shadow .15s ease, filter .15s ease; backdrop-filter: blur(1px);}
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="chat-container"></div>
<div id="input-container">
  <input type="text" id="user-input" placeholder="Ask Percy something..." />
  <button id="send-btn">Send</button>
</div>

<script src="./js/percy.js"></script>
<script>
// Chat elements
const chatBox = document.getElementById('chat-container');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

// Async typeMessage function
function typeMessageAsync(sender, msg, speed=25){
    return new Promise(resolve=>{
        const p = document.createElement('p');
        p.textContent = `${sender}: `;
        chatBox.appendChild(p);
        let i=0;
        function typeNext(){
            if(i<msg.length){
                p.textContent += msg[i];
                i++;
                chatBox.scrollTop = chatBox.scrollHeight;
                setTimeout(typeNext, speed);
            } else resolve();
        }
        typeNext();
    });
}

// Simple dynamic thinker
function PercyThink(input){
    input = input.toLowerCase();
    if(input.includes('hello') || input.includes('hi')) return "Hello! How are you today?";
    if(input.includes('how are you')) return "I am fully operational, thank you for asking!";
    if(input.includes('your name')) return "I am Percy, your AI companion.";
    if(input.includes('what can you do')) return "I can speak, think, and even rewrite my own logic safely!";
    // fallback
    return "Hmm, tell me moreâ€¦";
}

// Override Percy speak to use typing
if(window.PercyState){
    PercyState.speak = async function(msg){
        await typeMessageAsync('ðŸ¤– Percy', msg);
    }
}

// Handle user input
async function handleUserInput(msg){
    if(!msg) return;
    await typeMessageAsync('You', msg);
    const response = PercyThink(msg);
    PercyState.speak(response);
}

// Send button
sendBtn.addEventListener('click',()=>{
    handleUserInput(input.value.trim());
    input.value='';
});

// Enter key
input.addEventListener('keydown', e=>{
    if(e.key==='Enter') sendBtn.click();
});

// Autonomous thoughts loop
async function enablePercyAutonomy(){
    if(!window.PercyState) return;

    PercyState.autonomousQueue = PercyState.autonomousQueue || [];
    PercyState.autonomousQueue.push("Hello! I am Percy, your AI companion.");
    PercyState.autonomousQueue.push("I can speak, think, and even rewrite my own logic safely.");

    while(true){
        if(PercyState.autonomousQueue.length){
            const thought = PercyState.autonomousQueue.shift();
            await PercyState.speak(thought);
        }

        if(PercyState.canRewriteCode){
            try{
                const code = await PercyState.getCode();
                const newCode = PercyState.rewriteCode(code);
                PercyState.updateCode(newCode);
                await PercyState.speak("I've improved my own logic autonomously!");
            }catch(e){
                await PercyState.speak("Error rewriting code: "+e.message);
            }
        }

        await new Promise(r=>setTimeout(r,10000));
    }
}

enablePercyAutonomy();
</script>
</body>
</html>
