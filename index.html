<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percy TrueAI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:absolute; top:0; left:0; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); }
  .node { position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; cursor:pointer;
         background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
         border:2px solid currentColor;
         box-shadow:0 0 6px currentColor, 0 0 14px currentColor, inset 0 0 12px rgba(255,255,255,0.08);
         text-shadow:0 1px 2px rgba(0,0,0,0.6);
         user-select:none; transition:transform .15s ease, box-shadow .15s ease, filter .15s ease; backdrop-filter: blur(1px);}
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }
  .cyan-bubble{color:#00eaff;}
  .blue-bubble{color:#27a0ff;}
  .magenta-bubble{color:#ff4af0;}
  .red-bubble{color:#ff3b3b;}
  .orange-bubble{color:#ff9d2e;}
  .yellow-bubble{color:#ffe44a;}
  .green-bubble{color:#4caf50;}
  #percy-console{position:absolute;bottom:0;left:0;width:100%;max-height:200px;overflow-y:auto;background:rgba(0,0,0,0.4);padding:8px;}
  #percy-message{position:absolute;top:0;left:0;width:100%;padding:4px;font-size:14px;}
  #seed-search, #ask-input{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 10px;border-radius:8px;border:1px solid #555;width:220px;background:#1a1a1a;color:white;}
  #ask-btn{padding:6px 10px;border-radius:6px;border:none;background:#2ac66d;color:white;cursor:pointer;}
</style>
</head>
<body>

<div id="logic-map">
  <div id="logic-nodes"></div>
  <div id="percy-console"></div>
  <div id="percy-message">Click a logic node to hear Percyâ€™s thoughts...</div>
</div>

<input id="seed-search" placeholder="Search seeds...">
<div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:4px;">
  <input type="text" id="ask-input" placeholder="Ask Percy...">
  <button id="ask-btn">Ask</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const SAFETY={maxActionsPerMinute:20,maxSeedsPerCycle:5,consoleLimit:500};
const OWNER={primary:"Fabian",secondary:"Lorena"};
const PERCY_VERSION="8.3.3-trueAI";

const Memory={
  _k:k=>`percy:${k}`,
  load(k,fallback){try{const raw=localStorage.getItem(this._k(k));return raw?JSON.parse(raw):(fallback??null);}catch{return fallback;}},
  save(k,v){try{localStorage.setItem(this._k(k),JSON.stringify(v));}catch{}},
  push(k,v,max=1000){const arr=this.load(k,[])||[];arr.push(v);if(arr.length>max)arr.shift();this.save(k,arr);}
};

const PercyState={
  gnodes: Memory.load("gnodes",{})||{},
  getNextId(){let next=801; while(this.gnodes[`G${String(next).padStart(3,'0')}`]) next++; return `G${String(next).padStart(3,'0')}`;},
  createSeed(msg,type='emergent',data={}){if(!OWNER.primary)return null; const id=this.getNextId(); this.gnodes[id]={message:msg,type,data}; Memory.save("gnodes",this.gnodes); return id;},
  updateSeed(id,upd){if(!this.gnodes[id])return; Object.assign(this.gnodes[id],upd); Memory.save("gnodes",this.gnodes);},
  
  // True autonomous thought
  autonomousThought(){
    const keys=Object.keys(this.gnodes); if(!keys.length)return;
    const selectedSeeds=keys.sort(()=>0.5-Math.random()).slice(0,Math.ceil(Math.random()*3)).map(k=>this.gnodes[k]);
    const words=selectedSeeds.map(s=>(s.message||"").split(/\s+/).filter(w=>w.length>3)).flat();
    if(!words.length)return;

    let sentence='';
    if(words.length>=3){const [w1,w2,w3]=words.sort(()=>0.5-Math.random()).slice(0,3); sentence=`I notice that ${w1} may relate to ${w2}, suggesting ${w3}.`;}
    else sentence=`Exploring relationships: ${words.join(', ')}.`;

    Memory.save('lastThought',sentence);
    UI.say(`ðŸ¤– Percy thinks: ${sentence}`);
    Voice.speak(sentence);
    this.createSeed(sentence,"thought",{source:"autonomousThought"});
  },

  evaluateSelf(){
    let created=0; const updatedIds=new Set();
    Object.entries(this.gnodes).forEach(([id,seed])=>{
      if(created>=SAFETY.maxSeedsPerCycle) return;
      if(/TODO|missing|empty/.test(seed.message) && !updatedIds.has(id)){
        this.updateSeed(id,{message:seed.message.replace(/TODO|missing|empty/,"auto-resolved by Percy")});
        updatedIds.add(id); created++;
      }
    });
    while(created<SAFETY.maxSeedsPerCycle && Math.random()<0.6){this.autonomousThought(); created++;}
  },

  selfRewrite(){
    const keys=Object.keys(this.gnodes); if(!keys.length)return;
    const id=keys[Math.floor(Math.random()*keys.length)];
    const seed=this.gnodes[id];
    if(seed && Math.random()<0.5){
      this.updateSeed(id,{message:seed.message+' [auto-refined]'});
      UI.say(`ðŸ”„ Percy auto-refined seed ${id}`);
      Voice.speak(`Auto refinement completed on seed ${id}`);
    }
  }
};

let seeds={};

const UI={
  elConsole:()=>document.getElementById('percy-console'),
  elMsg:()=>document.getElementById('percy-message'),
  say(txt){const box=this.elConsole(); if(!box)return; const p=document.createElement('p'); p.textContent=txt; box.appendChild(p); box.scrollTop=box.scrollHeight; while(box.children.length>SAFETY.consoleLimit) box.removeChild(box.firstChild);},
  setStatus(txt){const m=this.elMsg(); if(m)m.textContent=txt;}
};

const Voice={enabled:true,lastSpoken:0,speak(text){try{if(!this.enabled||!('speechSynthesis' in window)||!text)return; const now=Date.now(); if(now-this.lastSpoken<300)return; this.lastSpoken=now; const u=new SpeechSynthesisUtterance(text); const pick=v=>v.find(vv=>/en(-|_|$)/i.test(vv.lang))||v[0]; const ensureVoice=()=>{const vs=speechSynthesis.getVoices(); if(vs?.length){u.voice=pick(vs);speechSynthesis.speak(u);} else {speechSynthesis.onvoiceschanged=()=>{const v2=speechSynthesis.getVoices(); u.voice=pick(v2); speechSynthesis.speak(u);};}}; u.rate=1.0; u.pitch=1.0; u.volume=1.0; ensureVoice();}catch{}}
};

const logicMap=document.getElementById('logic-map');
const logicNodes=document.getElementById('logic-nodes');
let zoomLevel=1,translateX=0,translateY=0;

function createNodes(){
  logicNodes.innerHTML='';
  const width=logicMap.clientWidth||800, height=logicMap.clientHeight||600;
  layoutRing(801,850,width,height,200,'cyan-bubble',40);
  layoutRing(851,900,width,height,150,'blue-bubble',30);
  layoutRing(901,950,width,height,100,'magenta-bubble',22);
  applyTransform();
}

function layoutRing(startId,endId,width,height,radius,colorClass,nodeSize){
  const ringSeeds=Object.entries(seeds).filter(([id])=>{const num=parseInt(id.replace("G","")); return num>=startId&&num<=endId;});
  const total=Math.max(1,ringSeeds.length);
  const centerX=width/2,centerY=height/2;
  ringSeeds.forEach(([id,data],index)=>{
    const angle=(index/total)*2*Math.PI;
    const x=centerX+radius*Math.cos(angle)-nodeSize/2;
    const y=centerY+radius*Math.sin(angle)-nodeSize/2;
    const node=document.createElement('div'); node.classList.add('node'); if(colorClass) node.classList.add(colorClass);
    node.style.width=node.style.height=`${nodeSize}px`;
    node.style.left=`${x}px`; node.style.top=`${y}px`;
    node.textContent=id;
    node.title=data?.message??id;
    node.addEventListener('click',()=>percyRespond(id,data));
    node.addEventListener('mouseenter',()=>UI.setStatus(data?.message??''));
    logicNodes.appendChild(node);
  });
}

function applyTransform(){
  logicNodes.style.transform=`translate(-50%,-50%) translate(${translateX}px,${translateY}px) scale(${zoomLevel})`;
}

function percyRespond(id,data){
  if(!data) return;
  UI.say(`âœ¨ Percy activated seed ${id}: ${data.message}`);
  Voice.speak(`Processing seed ${id}`);
}

document.getElementById('ask-btn').addEventListener('click', ()=>{
  const val=document.getElementById('ask-input').value.trim(); if(!val) return;
  PercyState.autonomousThought();
  createNodes();
  document.getElementById('ask-input').value='';
});

document.getElementById('seed-search').addEventListener('input', e=>{
  const val=e.target.value.toUpperCase();
  document.querySelectorAll('.node').forEach(n=>{ n.style.display=n.textContent.includes(val)?'flex':'none'; });
});

logicMap.addEventListener('wheel', e=>{
  e.preventDefault();
  const factor=0.1;
  zoomLevel *= e.deltaY<0?1+factor:1-factor;
  zoomLevel=Math.min(Math.max(0.2,zoomLevel),6);
  applyTransform();
});

let isDragging=false,lastX=0,lastY=0;
logicMap.addEventListener('mousedown', e=>{isDragging=true; lastX=e.clientX; lastY=e.clientY;});
logicMap.addEventListener('mousemove', e=>{if(isDragging){const dx=e.clientX-lastX,dy=e.clientY-lastY; translateX+=dx; translateY+=dy; lastX=e.clientX; lastY=e.clientY; applyTransform();}});
logicMap.addEventListener('mouseup', e=>{isDragging=false;});
logicMap.addEventListener('mouseleave', e=>{isDragging=false;});

function startPercyLoop(){
  setInterval(()=>{
    PercyState.evaluateSelf();
    PercyState.selfRewrite();
    createNodes();
    UI.setStatus(`ðŸŸ¢ Percy active, ${Object.keys(seeds).length} seeds loaded`);
  },3000);
}

function animateBubbles(){
  const nodes=document.querySelectorAll('.node');
  nodes.forEach(n=>{const glow=4+Math.random()*4; n.style.boxShadow=`0 0 ${glow*2}px currentColor, 0 0 ${glow*4}px currentColor, inset 0 0 ${glow*3}px rgba(255,255,255,0.08)`;});
  requestAnimationFrame(animateBubbles);
}

startPercyLoop();
animateBubbles();
UI.say(`âœ… Percy TrueAI v${PERCY_VERSION} initialized`);
Voice.speak(`Percy TrueAI online`);

window.Percy={percyRespond};
createNodes();

});
</script>
</body>
</html>
