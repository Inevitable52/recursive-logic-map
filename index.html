<script>
  function logToConsole(...messages) {
    const consoleDiv = document.getElementById("percy-console");
    const message = messages.join(" ");
    const line = document.createElement("div");
    line.textContent = message;
    consoleDiv.appendChild(line);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }

  function setupUserInputHandler() {
    const userInput = document.getElementById("user-input");
    if (!userInput) return;

    userInput.addEventListener("keydown", async (event) => {
      if (event.key === "Enter") {
        const input = event.target.value.trim();
        if (!input) return;

        logToConsole(`💬 You: ${input}`);

        try {
          const apiUrl = `${location.origin}/api/openai`; // 🔄 Dynamic API URL
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'gpt-4',
              messages: [{ role: 'user', content: input }]
            })
          });

          const data = await response.json();
          const reply = data.choices?.[0]?.message?.content || 'No response from Percy.';
          logToConsole(`🤖 Percy: ${reply}`);
        } catch (err) {
          logToConsole('❌ Error reaching Percy server:', err.message);
        }

        event.target.value = '';
      }
    });
  }

  window.addEventListener('DOMContentLoaded', setupUserInputHandler);
</script>
