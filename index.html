<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Skynet A.I</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg:#0a0a0f;
    --neon-a:#00ffff;
    --neon-b:#ff00ff;
    --accent:#1aff55;
    --head-size:520px;
  }

  html, body { height:100%; margin:0; background:var(--bg); color:#e8eefc; font-family:Consolas, monospace; overflow:hidden; }

  #logic-map{position:relative;width:100vw;height:100vh;background:#090912;}
  #logic-nodes{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}

  /* AI Head */
  #ai-head-wrap{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);width:var(--head-size);height:var(--head-size);z-index:1200;pointer-events:none;display:flex;align-items:center;justify-content:center;}
  canvas#ai-head{width:100%;height:100%;border-radius:18px;filter:drop-shadow(0 12px 40px rgba(0,0,0,0.7));}

  /* console / message */
  #percy-console{position:fixed;left:6px;bottom:6px;width:34%;max-height:44%;overflow:auto;padding:12px;background:rgba(0,0,0,0.6);border-top-right-radius:12px;border:1px solid #222;z-index:1400;}
  .console-line{font-size:12px;margin:4px 0;font-family:monospace;}
  .console-line.ask{color:#cfe8ff;}
  .console-line.exec{color:#9fffb0;}
  #percy-message{position:fixed;left:34.5%;bottom:6px;width:65.5%;padding:12px;background:rgba(0,0,0,0.6);border-top-left-radius:12px;border:1px solid #222;z-index:1399;max-height:28%;overflow:auto;}

  /* header inputs */
  input, textarea, button{font-family:monospace;}
  #seed-search{position:fixed;top:12px;left:12px;width:200px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1800;}
  #interpreter-input{position:fixed;top:12px;left:220px;width:320px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1800;}
  #askPercyButton{position:fixed;top:12px;left:550px;padding:6px 12px;border-radius:6px;background:#1a1aff;color:#fff;border:none;cursor:pointer;z-index:1800;}
  #askPercyButton:hover{background:#3333ff;}

  #exec-toggle{position:fixed;top:52px;left:220px;z-index:1800;}
  #exec-toggle button{padding:4px 12px;margin-right:6px;border-radius:6px;border:0;background:#333;color:#fff;cursor:pointer;}
  #exec-toggle button.active{background:var(--accent);color:#000;}

  #percy-exec-input{position:fixed;top:90px;left:220px;width:320px;padding:6px;border-radius:6px;border:1px solid #333;background:#0b0b0f;color:#fff;z-index:1800;}
  #percy-exec-run{position:fixed;top:90px;left:550px;padding:6px 12px;border-radius:6px;border:0;background:var(--accent);color:#000;cursor:pointer;z-index:1800;}

  /* Camera */
  #camera-feed{position:fixed;top:150px;right:12px;width:480px;height:360px;border-radius:16px;border:2px solid var(--neon-a);box-shadow:0 0 18px var(--neon-a),0 0 36px var(--neon-b);background:#000;object-fit:cover;z-index:1200;transition:transform .25s;}
  #camera-feed:hover{transform:scale(1.03);}
  #camera-overlay{position:fixed;top:150px;right:12px;width:480px;height:360px;pointer-events:none;z-index:1300;}

  /* audio visualizer */
  #voice-visualizer{position:fixed;top:12px;right:12px;width:360px;height:128px;border-radius:12px;background:linear-gradient(180deg,rgba(7,7,12,0.6),rgba(7,7,12,0.35));box-shadow:0 6px 24px rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.08);z-index:9999;display:flex;align-items:center;justify-content:center;}
  #voice-canvas{width:100%;height:100%;border-radius:8px;background:transparent;}

  /* puppeteer + chat */
  #puppeteer-control{position:fixed;bottom:20px;left:50%;transform:translateX(-220px);width:420px;max-width:46vw;background:rgba(0,0,0,0.8);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 6px 30px rgba(0,0,0,0.6),0 0 18px var(--neon-a);z-index:1300;color:#e8eefc;display:flex;align-items:center;justify-content:center;}
  #puppeteer-control .title{font-family:monospace;font-size:13px;opacity:0.9;}

  #percy-chat-box{position:fixed;bottom:20px;left:50%;transform:translateX(40px);width:340px;height:400px;background:rgba(0,0,0,0.75);border-radius:12px;border:1px solid #222;display:flex;flex-direction:column;z-index:1350;box-shadow:0 8px 30px rgba(0,0,0,0.6),0 0 18px var(--neon-b);}
  #percy-chat-messages{flex:1;padding:8px;overflow:auto;}
  #percy-chat-input{flex:1;padding:6px;border:0;background:#111;color:#fff;}
  #percy-chat-send{padding:6px 10px;border:0;background:var(--accent);color:#000;cursor:pointer;border-radius:6px;}

  @media (max-width:900px){
    #camera-feed{width:360px;height:270px;}
    #camera-overlay{width:360px;height:270px;}
    #puppeteer-control{transform:translateX(-50%);left:50%;width:320px;bottom:140px;}
    #percy-chat-box{transform:translateX(-50%);left:50%;bottom:20px;width:320px;}
  }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>

<div id="ai-head-wrap" aria-hidden="true">
  <canvas id="ai-head"></canvas>
</div>

<div id="percy-console" aria-live="polite"></div>
<div id="percy-message"></div>

<input id="seed-search" placeholder="Search seeds" />
<input id="interpreter-input" placeholder="Ask Percy" />
<button id="askPercyButton">Run</button>

<div id="exec-toggle">
  <button data-mode="math" class="active">Math</button>
  <button data-mode="java">Java</button>
  <button data-mode="tools">Tools</button>
</div>

<textarea id="percy-exec-input" rows="3" placeholder="Percy Exec (Math/Java/Tools)"></textarea>
<button id="percy-exec-run">Run Exec</button>

<video id="camera-feed" autoplay muted playsinline></video>
<canvas id="camera-overlay"></canvas>

<div id="voice-visualizer"><canvas id="voice-canvas"></canvas></div>

<div id="puppeteer-control" role="region" aria-label="Puppeteer control">
  <div class="title">‚òï Puppeteer</div>
</div>

<div id="percy-chat-box">
  <div id="percy-chat-messages"></div>
  <div style="display:flex;border-top:1px solid #222;padding:6px;">
    <input id="percy-chat-input" placeholder="Talk to Percy..." />
    <button id="percy-chat-send">Send</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
<script src="js/percy.js?v=6.4"></script>

<script>
// === PartZ: Camera + Vision + Audio Visualizer ===
Percy.PartZ = (function(){
  const PartZ = {};
  const video = document.getElementById('camera-feed');
  const overlay = document.getElementById('camera-overlay');
  const overlayCtx = overlay.getContext('2d',{willReadFrequently:false});
  let audioCtx=null, analyser=null, dataFreq=null, dataWave=null;
  let cocoModel=null, faceModel=null;

  function appendConsole(text,cls){
    const el = document.createElement('div');
    el.className='console-line'+(cls?' '+cls:'');
    el.textContent=text;
    const c = document.getElementById('percy-console');
    c.appendChild(el);
    c.scrollTop = c.scrollHeight;
  }

  function resizeOverlay(){
    overlay.width = video.videoWidth || video.clientWidth || 640;
    overlay.height = video.videoHeight || video.clientHeight || 480;
    overlay.style.width = video.clientWidth+'px';
    overlay.style.height = video.clientHeight+'px';
  }

  async function initModels(){
    appendConsole('üîç Loading models...','exec');
    cocoModel = await cocoSsd.load();
    faceModel = await blazeface.load();
    appendConsole('‚úÖ Models loaded (Coco-SSD + BlazeFace)','exec');
  }

  async function detect(){
    if(video.readyState<2){ requestAnimationFrame(detect); return; }
    const [objects, faces] = await Promise.all([
      cocoModel.detect(video),
      faceModel.estimateFaces(video,false)
    ]);

    overlayCtx.clearRect(0,0,overlay.width,overlay.height);
    const scaleX = overlay.width / video.videoWidth;
    const scaleY = overlay.height / video.videoHeight;

    for(const obj of objects){
      const [x,y,w,h] = obj.bbox;
      overlayCtx.strokeStyle='rgba(0,255,255,0.9)';
      overlayCtx.lineWidth=2;
      overlayCtx.strokeRect(x*scaleX,y*scaleY,w*scaleX,h*scaleY);
      overlayCtx.fillStyle='rgba(0,255,255,0.5)';
      overlayCtx.font='12px monospace';
      overlayCtx.fillText(`${obj.class} (${Math.round(obj.score*100)}%)`, x*scaleX+4, y*scaleY+12);
    }

    for(const face of faces){
      const [x1,y1]=face.topLeft;
      const [x2,y2]=face.bottomRight;
      const w=(x2-x1)*scaleX, h=(y2-y1)*scaleY;
      overlayCtx.strokeStyle='rgba(255,0,255,0.9)';
      overlayCtx.lineWidth=2;
      overlayCtx.strokeRect(x1*scaleX,y1*scaleY,w,h);
      overlayCtx.fillStyle='rgba(255,0,255,0.3)';
      overlayCtx.fillText('Face', x1*scaleX+4,y1*scaleY+12);
    }

    if(typeof Percy.onVisualInput==='function') Percy.onVisualInput({objects,faces});
    requestAnimationFrame(detect);
  }

  function startAudioVisualizer(canvas){
    const ctxV = canvas.getContext('2d');
    function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
    resize(); window.addEventListener('resize', resize);
    (function draw(){
      requestAnimationFrame(draw);
      if(!analyser) return;
      analyser.getByteFrequencyData(dataFreq);
      analyser.getByteTimeDomainData(dataWave);
      const W=canvas.width,H=canvas.height;
      ctxV.clearRect(0,0,W,H);
      const barCount = dataFreq.length;
      const barW = Math.max(1,W/barCount);
      for(let i=0;i<barCount;i++){
        const v=dataFreq[i]/255, h=v*H*0.5;
        ctxV.fillStyle=`rgb(${dataFreq[i]},${255-dataFreq[i]},255)`;
        ctxV.fillRect(i*barW,H-h,barW*0.7,h);
      }
      ctxV.lineWidth=2;
      ctxV.strokeStyle='rgba(0,255,255,0.95)';
      ctxV.beginPath();
      let x=0;
      for(let i=0;i<dataWave.length;i++){
        const v=(dataWave[i]-128)/128;
        const y=H/2+v*(H*0.22);
        if(i===0) ctxV.moveTo(x,y); else ctxV.lineTo(x,y);
        x+=W/dataWave.length;
      }
      ctxV.stroke();
    })();
  }

  PartZ.init = async function(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      video.srcObject = stream;
      await video.play();
      resizeOverlay();
      window.addEventListener('resize', resizeOverlay);
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize=256;
      dataFreq=new Uint8Array(analyser.frequencyBinCount);
      dataWave=new Uint8Array(analyser.frequencyBinCount);
      const srcNode = audioCtx.createMediaStreamSource(stream);
      srcNode.connect(analyser);
      const vc = document.getElementById('voice-canvas');
      startAudioVisualizer(vc);
      await initModels();
      detect();
      appendConsole('‚úÖ PartZ initialized','exec');
    } catch(err){ appendConsole('‚ö†Ô∏è PartZ init failed: '+err.message,'exec'); }
  };

  return PartZ;
})();

// start everything
window.addEventListener('load', ()=>{ try{ Percy.PartZ.init(); }catch(e){ console.error(e);} });
</script>
</body>
</html>
