<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
  .console-line { margin:2px 0; font-family:ui-monospace,Monaco,Consolas, monospace; font-size:12px; color:#d6d8ff; }
  #percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
  #percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }

  /* Visualizer (top-right, compact) */
  #voice-visualizer {
    position:fixed;
    top:12px;
    right:12px;
    width:360px;
    height:128px;
    pointer-events:none;
    z-index:9999;
    display:flex;
    align-items:center;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(7,7,12,0.6), rgba(7,7,12,0.35));
    box-shadow: 0 6px 24px rgba(0,255,255,0.08), inset 0 1px 0 rgba(255,255,255,0.02);
    border:1px solid rgba(0,255,255,0.1);
  }
  #voice-canvas {
    flex:1;
    height:100%;
    width:100%;
    display:block;
    border-radius:8px;
    background: linear-gradient(180deg, rgba(0,0,0,0.1), rgba(0,0,0,0.05));
  }
</style>
</head>
<body>
  <div id="logic-map"><div id="logic-nodes"></div></div>
  <div id="percy-console"></div>
  <div id="percy-message"></div>

  <input id="seed-search" placeholder="Search seeds" style="position:fixed;top:12px;left:12px;padding:6px;width:200px;z-index:9999;">
  <input id="interpreter-input" placeholder="Ask Percy" style="position:fixed;top:12px;left:220px;padding:6px;width:300px;z-index:9999;">

  <!-- Percy core stays intact -->
  <script src="js/percy.js?v=6.4"></script>

  <!-- Visualizer -->
  <div id="voice-visualizer" aria-hidden="true">
    <canvas id="voice-canvas"></canvas>
  </div>

<script>
// === Voice Visualizer ===
(function(){
  const canvas = document.getElementById('voice-canvas');
  const ctx = canvas.getContext('2d');
  let w=1,h=1;
  function resize(){
    w=canvas.clientWidth; h=canvas.clientHeight;
    const ratio=window.devicePixelRatio||1;
    canvas.width=w*ratio; canvas.height=h*ratio;
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  window.addEventListener('resize',resize); resize();

  let envelope=0, target=0, pulseUntilTs=0;
  function speakAnimation(len){
    target=Math.max(target,Math.min(1,Math.sqrt(len)/8));
    pulseUntil(Date.now()+Math.max(1200,len*55));
  }
  function pulseUntil(ts){ pulseUntilTs=Math.max(pulseUntilTs,ts); }

  const barCount=20;
  const barStates=new Array(barCount).fill(0);
  const barPhases=barStates.map((_,i)=>i*0.5+Math.random()*2);

  function draw(now){
    requestAnimationFrame(draw);
    const nowMs=Date.now();
    if(pulseUntilTs>nowMs) target=Math.max(target,0.25+0.75*Math.abs(Math.sin(now/120)));
    else target=Math.max(0,target-0.003);
    envelope+=(target-envelope)*0.15;

    ctx.clearRect(0,0,w,h);

    // Bars
    const barWidth=w/barCount*0.6;
    for(let i=0;i<barCount;i++){
      const rnd=0.5+0.5*Math.abs(Math.sin(now/200+barPhases[i]));
      const val=(0.1+envelope*(0.6+0.4*Math.random()))*rnd;
      barStates[i]+=(val-barStates[i])*0.25;
      const barHeight=Math.round(barStates[i]*(h*0.7));
      const x=i*(w/barCount)+(w/barCount-barWidth)/2;
      const y=h-barHeight;
      const hue=180+i*6;
      const grad=ctx.createLinearGradient(x,y,x,y+barHeight);
      grad.addColorStop(0,`hsl(${hue},100%,65%)`);
      grad.addColorStop(1,`hsl(${hue+40},100%,50%)`);
      ctx.fillStyle=grad;
      ctx.fillRect(x,y,barWidth,barHeight);
    }

    // Wave
    const baseY=h*0.75, amp=6+envelope*40, freq=1.0+envelope*4, elapsed=now/1000;
    for(let layer=0;layer<3;layer++){
      ctx.beginPath();
      ctx.lineWidth=1.5+layer;
      const hue=185+Math.sin(elapsed*1.2+layer)*12;
      ctx.strokeStyle=`hsla(${hue},100%,${55-layer*6}%,0.9)`;
      for(let x=0;x<w;x+=2){
        const y=baseY+Math.sin(x*(0.004*freq)+elapsed*(1.6+layer*0.6))*amp;
        if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }
  }
  requestAnimationFrame(draw);

  // Hook into Percyâ€™s voice
  function wrap(){
    if(window.Voice && typeof window.Voice.speak==='function'){
      const orig=window.Voice.speak.bind(window.Voice);
      window.Voice.speak=function(txt){ speakAnimation(String(txt??'').length); return orig(txt); };
      return true;
    }
    return false;
  }
  if(!wrap()) window.addEventListener('load',wrap);

  // Demo
  setTimeout(()=>{ if(!window.Voice) speakAnimation(48); },800);
  window.__percy_visual_speak=speakAnimation;
})();
</script>

<script>
// === Ask Percy input ===
const interpreterInput=document.getElementById('interpreter-input');
if(interpreterInput){
  interpreterInput.addEventListener('keydown',function(e){
    if(e.key==='Enter'){
      const query=interpreterInput.value.trim();
      if(query){
        if(typeof percyRespond==='function'){ percyRespond(query); }
        else if(window.Percy && typeof Percy.interpret==='function'){ Percy.interpret(query); }
        interpreterInput.value='';
      }
    }
  });
}
</script>
</body>
</html>
