<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
#logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
#logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
.console-line { margin:2px 0; font-family:monospace; font-size:12px; }
.console-line.ask { color:#d6d8ff; }
.console-line.exec { color:#7fff7f; }
#percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
#percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }
#askPercyButton,#percy-exec-run { padding:6px 12px; color:white; border:none; border-radius:6px; cursor:pointer; z-index:9999; }
#askPercyButton { position:fixed; top:12px; left:530px; background:#1a1aff; }
#askPercyButton:hover { background:#3333ff; }
#percy-exec-run { position:fixed; top:90px; left:530px; background:#1aff55; }
#percy-exec-run:hover { background:#33ff77; }
#interpreter-input,#percy-exec-input,#seed-search { position:fixed; padding:6px; z-index:9999; width:300px; }
#seed-search { top:12px; left:12px; width:200px; }
#interpreter-input { top:12px; left:220px; }
#percy-exec-input { top:90px; left:220px; width:300px; }
#exec-toggle { position:fixed; top:50px; left:220px; z-index:9999; }
#exec-toggle button { padding:4px 12px; margin-right:6px; border:none; border-radius:6px; cursor:pointer; background:#333; color:white; }
#exec-toggle button.active { background:#1aff55; color:black; }

/* === Percy Chat Box === */
#percy-chat-box {
  position:fixed; bottom:50px; right:12px; width:320px; height:400px;
  background:rgba(0,0,0,0.75); border:1px solid #333; border-radius:12px;
  display:flex; flex-direction:column; overflow:hidden; font-family:monospace;
  z-index:9999;
}
#percy-chat-messages { flex:1; padding:8px; overflow-y:auto; }
#percy-chat-input {
  flex:1; padding:6px; border:none; background:#111; color:white;
}
#percy-chat-send {
  padding:6px 10px; background:#1aff55; color:black; border:none; cursor:pointer;
}

/* === Camera Feed === */
#camera-feed { position:fixed; top:150px; right:12px; width:320px; height:240px; border:1px solid #333; border-radius:12px; z-index:9999; }
#camera-overlay { position:fixed; top:150px; right:12px; width:320px; height:240px; pointer-events:none; z-index:10000; }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="percy-console"></div>
<div id="percy-message"></div>

<input id="seed-search" placeholder="Search seeds">
<input id="interpreter-input" placeholder="Ask Percy">
<button id="askPercyButton">Run</button>

<div id="exec-toggle">
  <button data-mode="math" class="active">Math</button>
  <button data-mode="java">Java</button>
  <button data-mode="tools">Tools</button>
</div>

<textarea id="percy-exec-input" placeholder="Percy Exec (Math/Java/Tools)" rows="4"></textarea>
<button id="percy-exec-run">Run Exec</button>

<script src="js/percy.js?v=6.4"></script>

<!-- === Camera Feed === -->
<video id="camera-feed" autoplay muted></video>
<canvas id="camera-overlay"></canvas>

<!-- === Percy Chat Box === -->
<div id="percy-chat-box">
  <div id="percy-chat-messages"></div>
  <div style="display:flex; border-top:1px solid #333;">
    <input id="percy-chat-input" type="text" placeholder="Talk to Percy...">
    <button id="percy-chat-send">Send</button>
  </div>
</div>

<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.9/dist/blazeface.min.js"></script>

<script>
// === Percy Part Z (Camera + Face Detection + Audio Visualizer) ===
Percy.PartZ = (function(){
  const PartZ = {};
  const video = document.getElementById('camera-feed');
  const canvas = document.getElementById('camera-overlay');
  const ctx = canvas.getContext('2d');

  let audioCtx, analyser, dataFreq, dataWave;
  let faceModel = null;

  PartZ.init = async function(){
    try {
      // Camera + mic
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      video.srcObject = stream;
      await video.play();

      // Canvas sizing
      function resizeCanvas(){ canvas.width=video.clientWidth; canvas.height=video.clientHeight; }
      resizeCanvas();
      window.addEventListener('resize',resizeCanvas);

      // Audio setup
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      dataFreq = new Uint8Array(analyser.frequencyBinCount);
      dataWave = new Uint8Array(analyser.frequencyBinCount);
      audioCtx.createMediaStreamSource(stream).connect(analyser);

      // Load BlazeFace
      faceModel = await blazeface.load();

      PartZ.loop();
    } catch(e){ console.error("Percy Part Z init failed:",e); }
  };

  function drawAudio(){
    if(!analyser) return;
    const W = canvas.width, H = canvas.height;
    analyser.getByteFrequencyData(dataFreq);
    analyser.getByteTimeDomainData(dataWave);

    // Bars
    const barWidth = W / dataFreq.length;
    for(let i=0;i<dataFreq.length;i++){
      const barH = dataFreq[i]/255 * H * 0.25;
      ctx.fillStyle = `rgb(${dataFreq[i]}, ${255-dataFreq[i]}, 255)`;
      ctx.fillRect(i*barWidth, H-barH, barWidth*0.6, barH);
    }

    // Sinewave
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(0,255,255,0.8)';
    ctx.beginPath();
    let x = 0;
    const slice = W / dataWave.length;
    for(let i=0;i<dataWave.length;i++){
      const y = (dataWave[i]/128 -1)*H*0.12 + H/2;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      x += slice;
    }
    ctx.stroke();
  }

  PartZ.loop = async function(){
    if(video.readyState < 2){ requestAnimationFrame(PartZ.loop); return; }

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Face detection
    if(faceModel){
      const predictions = await faceModel.estimateFaces(video,false);
      predictions.forEach(p=>{
        const [x1,y1] = p.topLeft;
        const [x2,y2] = p.bottomRight;
        const w = x2-x1, h = y2-y1;
        ctx.strokeStyle = 'rgba(0,255,255,0.9)';
        ctx.lineWidth = 2;
        ctx.strokeRect(x1,y1,w,h);
      });
    }

    // Draw audio bars + sinewave
    drawAudio();

    requestAnimationFrame(PartZ.loop);
  };

  return PartZ;
})();

Percy.PartZ.init();
</script>

</body>
</html>
