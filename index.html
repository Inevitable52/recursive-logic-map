<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P.E.R.C.Y - AI</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
#logic-map { position:relative; width:100vw; height:100vh; background:#0a0a0f; overflow:hidden; }
#logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
.console-line { margin:2px 0; font-family:monospace; font-size:12px; }
.console-line.ask { color:#d6d8ff; }
.console-line.exec { color:#7fff7f; }
#percy-console { position:fixed; bottom:0; left:0; width:35%; max-height:40%; overflow:auto; background:rgba(0,0,0,0.65); padding:6px; border-top-right-radius:12px; border:1px solid #444; }
#percy-message { position:fixed; bottom:0; left:35%; width:65%; padding:6px; background:rgba(0,0,0,0.65); border-top-left-radius:12px; border:1px solid #444; }
#askPercyButton,#percy-exec-run { padding:6px 12px; color:white; border:none; border-radius:6px; cursor:pointer; z-index:9999; }
#askPercyButton { position:fixed; top:12px; left:530px; background:#1a1aff; }
#askPercyButton:hover { background:#3333ff; }
#percy-exec-run { position:fixed; top:90px; left:530px; background:#1aff55; }
#percy-exec-run:hover { background:#33ff77; }
#interpreter-input,#percy-exec-input,#seed-search { position:fixed; padding:6px; z-index:9999; width:300px; }
#seed-search { top:12px; left:12px; width:200px; }
#interpreter-input { top:12px; left:220px; }
#percy-exec-input { top:90px; left:220px; width:300px; }
#exec-toggle { position:fixed; top:50px; left:220px; z-index:9999; }
#exec-toggle button { padding:4px 12px; margin-right:6px; border:none; border-radius:6px; cursor:pointer; background:#333; color:white; }
#exec-toggle button.active { background:#1aff55; color:black; }

/* === Percy Chat Box === */
#percy-chat-box {
  position:fixed; bottom:50px; right:12px; width:320px; height:400px;
  background:rgba(0,0,0,0.75); border:1px solid #333; border-radius:12px;
  display:flex; flex-direction:column; overflow:hidden; font-family:monospace;
  z-index:9999;
}
#percy-chat-messages { flex:1; padding:8px; overflow-y:auto; }
#percy-chat-input {
  flex:1; padding:6px; border:none; background:#111; color:white;
}
#percy-chat-send {
  padding:6px 10px; background:#1aff55; color:black; border:none; cursor:pointer;
}

/* === Voice Visualizer (top-right) === */
#voice-visualizer { position:fixed; top:12px; right:12px; width:360px; height:128px; pointer-events:none; display:flex; align-items:center; border-radius:12px; background:linear-gradient(180deg,rgba(7,7,12,0.6),rgba(7,7,12,0.35)); box-shadow:0 6px 24px rgba(0,255,255,0.08), inset 0 1px 0 rgba(255,255,255,0.02); border:1px solid rgba(0,255,255,0.1); z-index:9999; }
#voice-canvas { flex:1; width:100%; height:100%; border-radius:8px; background:linear-gradient(180deg,rgba(0,0,0,0.1),rgba(0,0,0,0.05)); }

/* === Camera Feed === */
#camera-feed { position:fixed; top:150px; right:12px; width:320px; height:240px; border:1px solid #333; border-radius:12px; z-index:9999; object-fit:cover; }
#camera-overlay { position:fixed; top:150px; right:12px; width:320px; height:240px; pointer-events:none; z-index:10000; }
</style>
</head>
<body>

<div id="logic-map"><div id="logic-nodes"></div></div>
<div id="percy-console"></div>
<div id="percy-message"></div>

<input id="seed-search" placeholder="Search seeds">
<input id="interpreter-input" placeholder="Ask Percy">
<button id="askPercyButton">Run</button>

<div id="exec-toggle">
  <button data-mode="math" class="active">Math</button>
  <button data-mode="java">Java</button>
  <button data-mode="tools">Tools</button>
</div>

<textarea id="percy-exec-input" placeholder="Percy Exec (Math/Java/Tools)" rows="4"></textarea>
<button id="percy-exec-run">Run Exec</button>

<!-- load main Percy core ONCE -->
<script src="js/percy.js?v=6.4"></script>

<!-- === Camera Feed === -->
<video id="camera-feed" autoplay muted playsinline></video>
<canvas id="camera-overlay"></canvas>

<!-- === Voice visualizer (top-right) === -->
<div id="voice-visualizer"><canvas id="voice-canvas"></canvas></div>

<!-- === Percy Chat Box === -->
<div id="percy-chat-box">
  <div id="percy-chat-messages"></div>
  <div style="display:flex; border-top:1px solid #333;">
    <input id="percy-chat-input" type="text" placeholder="Talk to Percy...">
    <button id="percy-chat-send">Send</button>
  </div>
</div>

<!-- TensorFlow + BlazeFace (loaded before PartZ) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.9/dist/blazeface.min.js"></script>

<script>
/* === Percy Part Z (Camera + Face Detection + Audio + Sinewave/Bars Overlay) === */
Percy.PartZ = (function() {
  const PartZ = {};
  const video = document.getElementById('camera-feed');
  const canvas = document.getElementById('camera-overlay');
  const ctx = canvas.getContext('2d');
  let audioCtx, analyser, dataFreq, dataWave;
  let faceModel = null;
  let prevFaces = 0;

  function resizeCanvas() {
    canvas.width = video.videoWidth || video.clientWidth || 320;
    canvas.height = video.videoHeight || video.clientHeight || 240;
  }

  PartZ.init = async function() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      video.srcObject = stream;
      await video.play();

      video.addEventListener('loadeddata', resizeCanvas);
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // Audio setup
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      dataFreq = new Uint8Array(analyser.frequencyBinCount);
      dataWave = new Uint8Array(analyser.frequencyBinCount);
      audioCtx.createMediaStreamSource(stream).connect(analyser);

      // Load BlazeFace
      console.log("Loading BlazeFace model...");
      faceModel = await blazeface.load();
      console.log("✅ BlazeFace model loaded.");
      PartZ.loop();
    } catch (e) {
      console.error("Percy Part Z init failed:", e);
    }
  };

  function drawAudioOverlay() {
    const W = canvas.width, H = canvas.height;
    analyser.getByteFrequencyData(dataFreq);
    analyser.getByteTimeDomainData(dataWave);

    // Bars (bottom)
    const barWidth = W / dataFreq.length;
    for (let i = 0; i < dataFreq.length; i++) {
      const barH = (dataFreq[i] / 255) * H * 0.3;
      ctx.fillStyle = `rgb(${dataFreq[i]}, ${255 - dataFreq[i]}, 255)`;
      ctx.fillRect(i * barWidth, H - barH, barWidth * 0.6, barH);
    }

    // Sinewave (center)
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(0,255,255,0.85)';
    ctx.beginPath();
    const slice = W / dataWave.length;
    for (let i = 0; i < dataWave.length; i++) {
      const v = (dataWave[i] / 128 - 1);
      const y = H / 2 + v * (H * 0.15);
      if (i === 0) ctx.moveTo(i * slice, y);
      else ctx.lineTo(i * slice, y);
    }
    ctx.stroke();
  }

  PartZ.loop = async function() {
    if (!video || !ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Face detection
    if (faceModel && video.readyState >= 2) {
      const predictions = await faceModel.estimateFaces(video, false);
      predictions.forEach(pred => {
        const [x1, y1] = pred.topLeft;
        const [x2, y2] = pred.bottomRight;
        const w = x2 - x1, h = y2 - y1;
        ctx.strokeStyle = 'rgba(0,255,0,0.9)';
        ctx.lineWidth = 3;
        ctx.strokeRect(x1, y1, w, h);
        ctx.font = "14px monospace";
        ctx.fillStyle = "rgba(0,255,0,0.9)";
        ctx.fillText("Face", x1 + 5, y1 - 5);
      });
    }

    drawAudioOverlay();
    requestAnimationFrame(PartZ.loop);
  };

  return PartZ;
})();
Percy.PartZ.init();
</script>

<script>
/* === Voice visualizer widget (uses PartZ analyser if available, otherwise requests audio) === */
(function(){
  const canvas = document.getElementById('voice-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
  resize(); window.addEventListener('resize', resize);

  let audioCtxLocal, analyserLocal, dataFreqLocal, dataWaveLocal;
  let usingSharedAnalyser = false;

  async function init() {
    // Prefer Percy.PartZ.shared analyser if present
    if (window.Percy && Percy.PartZ && Percy.PartZ.analyser) {
      analyserLocal = Percy.PartZ.analyser;
      usingSharedAnalyser = true;
    } else {
      try {
        audioCtxLocal = new (window.AudioContext||window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        const src = audioCtxLocal.createMediaStreamSource(stream);
        analyserLocal = audioCtxLocal.createAnalyser();
        analyserLocal.fftSize = 256;
        src.connect(analyserLocal);
      } catch(e) {
        console.warn("Voice visualizer audio init failed:", e);
        return;
      }
    }
    dataFreqLocal = new Uint8Array(analyserLocal.frequencyBinCount);
    dataWaveLocal = new Uint8Array(analyserLocal.frequencyBinCount);
    draw();
  }

  function draw(){
    requestAnimationFrame(draw);
    if(!analyserLocal) return;
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    analyserLocal.getByteFrequencyData(dataFreqLocal);
    analyserLocal.getByteTimeDomainData(dataWaveLocal);

    // bars
    const barWidth = Math.max(1, W / dataFreqLocal.length);
    for(let i=0;i<dataFreqLocal.length;i++){
      const barH = (dataFreqLocal[i]/255) * (H*0.6); // fill more of visualizer
      ctx.fillStyle = `rgb(${dataFreqLocal[i]}, ${255-dataFreqLocal[i]}, 255)`;
      ctx.fillRect(i*barWidth, H - barH, barWidth*0.6, barH);
    }

    // sinewave
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(0,255,255,0.9)';
    ctx.beginPath();
    let x=0;
    const slice = W / dataWaveLocal.length;
    for(let i=0;i<dataWaveLocal.length;i++){
      const y = H/2 + (dataWaveLocal[i]/128 - 1) * (H*0.2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      x += slice;
    }
    ctx.stroke();
  }

  // start on first user interaction (browser autoplay rules)
  ['click','keydown','touchstart'].forEach(evt=>{
    window.addEventListener(evt, function once(){ init(); window.removeEventListener(evt, once); }, {passive:true});
  });

  // Also try to init if shared analyser is already available
  if (window.Percy && Percy.PartZ && Percy.PartZ.analyser) init();

})();
</script>

<!-- === Console, Exec, Chat logic (unchanged) === -->
<script>
(function(){
  const interpreterInput = document.getElementById('interpreter-input'),
        percyConsole = document.getElementById('percy-console'),
        askButton = document.getElementById('askPercyButton');

  function appendConsole(text,isUser=false,exec=false){
    const line=document.createElement('div');
    line.className='console-line '+(isUser?'ask':'')+(exec?' exec':'' );
    line.textContent=(isUser?'↳ ':'')+text;
    percyConsole.appendChild(line);
    percyConsole.scrollTop = percyConsole.scrollHeight;
  }

  function runPercyCommand(){
    const query = interpreterInput.value.trim();
    if(!query) return;
    appendConsole(query,true);
    let response="";
    if(typeof percyRespond==='function') response=percyRespond(query);
    else if(window.Percy && typeof Percy.interpret==='function') response=Percy.interpret(query);
    if(response){
      appendConsole(response,false,false);
      if(Percy?.speak && !response.includes("Logic network idle")){
        Percy.speak(response);
      }
    }
    interpreterInput.value='';
  }

  interpreterInput.addEventListener('keydown',e=>{ if(e.key==='Enter') runPercyCommand(); });
  askButton.addEventListener('click',runPercyCommand);
})();
</script>

<script>
(function(){
  const execInput=document.getElementById('percy-exec-input'),
        execBtn=document.getElementById('percy-exec-run'),
        consoleDiv=document.getElementById('percy-console'),
        toggleBtns=document.querySelectorAll('#exec-toggle button');

  if(!execInput) return;
  let PercyExecMode="math";

  toggleBtns.forEach(btn=>btn.addEventListener('click',()=>{
    toggleBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    PercyExecMode=btn.dataset.mode;
  }));

  async function handleExecInput(){
    const query=execInput.value.trim(); if(!query) return; execInput.value="";
    const userLine=document.createElement("div");
    userLine.className="console-line ask";
    userLine.textContent="↳ "+query;
    consoleDiv.appendChild(userLine);

    let output="";
    try {
      if(PercyExecMode==="math") output = await PercyState.useTool("math", query);
      else if(PercyExecMode==="java") output = await PercyState.useTool("java", query);
      else if(PercyExecMode==="tools") output = await PercyState.PartH?.routeInput(query) || "⚠️ Percy Part H not loaded.";
    } catch(e){ output = "⚠️ Exec error: "+e.message; }

    const percyLine=document.createElement("div");
    percyLine.className="console-line exec";
    percyLine.textContent="🤖 "+output;
    consoleDiv.appendChild(percyLine);
    consoleDiv.scrollTop=consoleDiv.scrollHeight;
  }

  execInput.addEventListener("keydown",async e=>{
    if(e.key==="Enter"){ e.preventDefault(); await handleExecInput(); }
  });
  execBtn.addEventListener("click",handleExecInput);
})();
</script>

<script>
(function(){
  const chatInput = document.getElementById('percy-chat-input');
  const chatSend = document.getElementById('percy-chat-send');
  const chatMessages = document.getElementById('percy-chat-messages');
  let percyMemory = [];

  function appendMsg(role, text) {
    const line = document.createElement('div');
    line.textContent = `${role}: ${text}`;
    line.style.margin = '6px 0';
    line.style.color = role === 'Percy' ? '#7fff7f' : '#d6d8ff';
    chatMessages.appendChild(line);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function PercyReply(userText) {
    let raw = "";
    if (Percy?.PartT?.hear) raw = Percy.PartT.hear(userText);
    else if (Percy?.interpret) raw = Percy.interpret(userText);
    else if (typeof percyRespond === 'function') raw = percyRespond(userText);
    else raw = "⚙️ Percy core logic not initialized yet.";

    percyMemory.push({ you: userText, percy: raw });
    if (percyMemory.length > 10) percyMemory.shift();
    appendMsg('Percy', raw);

    if(Percy?.speak && !raw.includes("Logic network idle")){
      Percy.speak(raw);
    }
  }

  function sendMessage(){
    const text = chatInput.value.trim();
    if (!text) return;
    appendMsg('You', text);
    chatInput.value = '';
    PercyReply(text);
  }

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

  // optional: if PartT has self-loop it will use its own timer; don't call loop repeatedly here
})();
</script>

</body>
</html>
