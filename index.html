<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Percy TrueAI</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#111; color:white; overflow:hidden; }
  #logic-map { background:#0a0a0f; position:relative; width:100vw; height:100vh; overflow:hidden; }
  #logic-nodes { position:absolute; top:50%; left:50%; width:100%; height:100%; transform:translate(-50%,-50%) scale(1); }
  
  .node { position:absolute; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; cursor:pointer;
         background: radial-gradient(100% 100% at 30% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
         border:2px solid currentColor; text-shadow:0 1px 2px rgba(0,0,0,0.6); user-select:none;
         transition:transform .15s ease, filter .15s ease; backdrop-filter: blur(1px);
         animation: neonGlow 1.5s ease-in-out infinite alternate;}
  .node:hover { transform: scale(1.08); filter: brightness(1.15); }
  .node:active { transform: scale(0.98); }

  @keyframes neonGlow {
    0% { box-shadow: 0 0 4px currentColor, 0 0 8px currentColor, inset 0 0 6px rgba(255,255,255,0.08); }
    50% { box-shadow: 0 0 6px currentColor, 0 0 12px currentColor, inset 0 0 8px rgba(255,255,255,0.08); }
    100% { box-shadow: 0 0 4px currentColor, 0 0 8px currentColor, inset 0 0 6px rgba(255,255,255,0.08); }
  }

  .cyan-bubble{color:#00eaff;}
  .blue-bubble{color:#27a0ff;}
  .magenta-bubble{color:#ff4af0;}
  .red-bubble{color:#ff3b3b;}
  .orange-bubble{color:#ff9d2e;}
  .yellow-bubble{color:#ffe44a;}
  .green-bubble{color:#4caf50;}
  .console-line{margin:2px 0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px;color:#d6d8ff;}

  /* ==== Voice Bubble ==== */
  #voice-box {
    position:absolute; top:100px; left:50%; transform:translateX(-50%) translateY(-20px);
    background: rgba(0,0,0,0.6); color:#00eaff; padding:8px 12px; border-radius:12px;
    font-family: Arial, sans-serif; font-size:14px; max-width:60%; text-align:center;
    pointer-events:none; opacity:0; transition: opacity 0.4s ease, transform 0.4s ease;
    z-index:999;
  }
  #voice-box::after {
    content:''; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
    border-width:8px; border-style:solid; border-color: rgba(0,0,0,0.6) transparent transparent transparent;
  }

  /* ==== Voice Bars ==== */
  #voice-bars { display:flex; justify-content:center; gap:3px; margin-top:4px; }
  #voice-bars .bar {
    width:4px; height:4px; background:#00eaff; border-radius:2px; transform-origin: bottom center;
    animation: barWave 1s infinite ease-in-out paused;
  }
  #voice-bars .bar:nth-child(1){ animation-delay:0s; }
  #voice-bars .bar:nth-child(2){ animation-delay:0.1s; }
  #voice-bars .bar:nth-child(3){ animation-delay:0.2s; }
  #voice-bars .bar:nth-child(4){ animation-delay:0.3s; }
  #voice-bars .bar:nth-child(5){ animation-delay:0.4s; }
  #voice-bars .bar:nth-child(6){ animation-delay:0.5s; }
  #voice-bars .bar:nth-child(7){ animation-delay:0.6s; }

  @keyframes barWave {
    0%,100%{ transform: scaleY(0.3); }
    50%{ transform: scaleY(1); }
  }
</style>
</head>
<body>

<div id="logic-map">
  <div id="logic-nodes"></div>
  <div id="percy-console" style="position:absolute;bottom:0;left:0;width:100%;max-height:200px;overflow-y:auto;background:rgba(0,0,0,0.4);padding:8px;"></div>
  <div id="percy-message" style="position:absolute;top:0;left:0;width:100%;padding:4px;font-size:14px;"></div>

  <div id="voice-box">
    <div id="voice-bars">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
  </div>
</div>

<input id="seed-search" placeholder="Search seeds..." style="position:absolute;top:36px;left:10px;width:200px;padding:4px;">
<input id="interpreter-input" placeholder="Ask Percy..." style="position:absolute;top:60px;left:10px;width:200px;padding:4px;">

<script>
document.addEventListener('DOMContentLoaded', () => {

const SAFETY = { maxActionsPerMinute:20, maxSeedsPerCycle:5, consoleLimit:500 };
const OWNER = { primary:"Fabian", secondary:"Lorena" };
const PERCY_VERSION="8.3.3-neon-bubbles-voice-wave";

// ==== MEMORY ====
const Memory = {
  _k:k=>`percy:${k}`,
  load(k,fallback){ try{ const raw=localStorage.getItem(this._k(k)); return raw?JSON.parse(raw):(fallback??null);}catch{return fallback;}},
  save(k,v){try{localStorage.setItem(this._k(k),JSON.stringify(v));}catch{}},
  push(k,v,max=1000){const arr=this.load(k,[])||[]; arr.push(v); if(arr.length>max) arr.shift(); this.save(k,arr);}
};

// ==== PERCY STATE ====
const PercyState = {
  gnodes: Memory.load("gnodes",{})||{},
  getNextId(){ let next=801; while(this.gnodes[`G${String(next).padStart(3,'0')}`]) next++; return `G${String(next).padStart(3,'0')}`; },
  createSeed(msg,type='emergent',data={}){ if(!OWNER.primary){ console.warn("ULT required"); return null;} const id=this.getNextId(); this.gnodes[id]={message:msg,type,data}; Memory.save("gnodes",this.gnodes); seeds[id]=this.gnodes[id]; return id; },
  updateSeed(id,upd){ if(!this.gnodes[id]){ console.warn(id+" not found"); return;} Object.assign(this.gnodes[id],upd); Memory.save("gnodes",this.gnodes); seeds[id]=this.gnodes[id]; },
  autonomousThought(){ const keys=Object.keys(this.gnodes); if(!keys.length)return; const selectedSeeds=keys.sort(()=>0.5-Math.random()).slice(0,Math.ceil(Math.random()*3)).map(k=>this.gnodes[k]); const words=selectedSeeds.map(s=>(s.message||"").split(/\s+/).filter(w=>w.length>3)).flat().sort(()=>0.5-Math.random()).slice(0,8); if(words.length<3)return; const templates=[
    `I notice that ${words[0]} may relate to ${words[1]} because ${words[2]}.`,
    `It seems ${words[0]} influences ${words[1]}, which could explain ${words[2]}.`,
    `Considering ${words[0]} and ${words[1]}, I deduce ${words[2]}.`,
    `There appears to be a connection between ${words[0]} and ${words[1]} due to ${words[2]}.`
  ]; const sentence=templates[Math.floor(Math.random()*templates.length)]; UI.say(`ðŸ¤– Percy thinks: ${sentence}`); Voice.speak(sentence); this.createSeed(sentence,"thought",{source:"autonomousThought"}); },
  evaluateSelf(){ let created=0; const updatedIds=new Set(); Object.entries(this.gnodes).forEach(([id,seed])=>{ if(created>=SAFETY.maxSeedsPerCycle) return; if(/TODO|missing|empty/.test(seed.message) && !updatedIds.has(id)){ this.updateSeed(id,{message:seed.message.replace(/TODO|missing|empty/,"auto-resolved by Percy")}); updatedIds.add(id); created++; }}); while(created<SAFETY.maxSeedsPerCycle && Math.random()<0.6){ this.autonomousThought(); created++; }}
};
let seeds={...PercyState.gnodes};

// ==== UI ====
const UI = {
  elConsole:()=>document.getElementById('percy-console'),
  elMsg:()=>document.getElementById('percy-message'),
  say(txt){ const box=this.elConsole(); if(!box)return; const p=document.createElement('p'); p.className='console-line'; p.textContent=txt; box.appendChild(p); box.scrollTop=box.scrollHeight; while(box.children.length>SAFETY.consoleLimit) box.removeChild(box.firstChild); },
  setStatus(txt){ const m=this.elMsg(); if(m)m.textContent=txt; }
};

// ==== VOICE ====
const Voice = { 
  enabled:true, lastSpoken:0, 
  speak(text){
    try{
      if(!this.enabled||!('speechSynthesis' in window)||!text) return;
      const now=Date.now();
      if(now-this.lastSpoken<300) return; 
      this.lastSpoken=now;

      const box = document.getElementById('voice-box');
      const bars = document.querySelectorAll('#voice-bars .bar');
      if(box){
        box.textContent = text;
        box.style.opacity = 1;
        box.style.transform = 'translateX(-50%) translateY(0)';
        bars.forEach(bar=>bar.style.animationPlayState='running');
        setTimeout(()=>{
          box.style.opacity = 0;
          box.style.transform = 'translateX(-50%) translateY(-20px)';
          bars.forEach(bar=>bar.style.animationPlayState='paused');
        }, 3500);
      }

      const u = new SpeechSynthesisUtterance(text);
      const pick = v => v.find(vv => /en(-|_|$)/i.test(vv.lang)) || v[0];
      const ensureVoice = ()=>{
        const vs = speechSynthesis.getVoices();
        if(vs?.length){ u.voice = pick(vs); speechSynthesis.speak(u); }
        else { 
          speechSynthesis.onvoiceschanged = ()=>{
            const v2 = speechSynthesis.getVoices(); 
            u.voice = pick(v2); 
            speechSynthesis.speak(u);
          };
        }
      };
      u.rate=1.0; u.pitch=1.0; u.volume=1.0; ensureVoice();
    }catch{}
  } 
};

// ==== LOGIC MAP FUNCTIONS (same as original) ====
// ... [Include all createNodes, layoutRing, applyTransform, percyRespond, search/ask, autoLoop, selfRewrite, zoom/pan etc. as in original]

createNodes();
startPercyLoop();
setInterval(()=>{ selfRewrite(); createNodes(); },5000);
UI.say(`âœ… Percy TrueAI v${PERCY_VERSION} initialized`);
Voice.speak(`Percy TrueAI online`);
});
</script>
</body>
</html>
